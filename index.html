<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirada Terapéutica</title>
    
    <!-- 1. Tailwind CSS (Diseño) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Motor de la App) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- 3. Babel (Para entender el código moderno en el navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Animaciones personalizadas */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-rose-50 text-stone-800">
    <div id="root"></div>

    <!-- CÓDIGO DE LA APLICACIÓN -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signOut, signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, setDoc, 
            arrayUnion, arrayRemove, onSnapshot, serverTimestamp, query, orderBy, 
            enableIndexedDbPersistence 
        } from 'firebase/firestore';
        import { 
            Camera, Send, X, QrCode, Heart, Image as ImageIcon, Loader2, WifiOff, 
            Copy, Check, Trash2, LogOut, AlertCircle, Info, Settings, Type, Sparkles, Lock, Share2, BookOpen
        } from 'lucide-react';

        // ==========================================
        //  CONFIGURACIÓN HÍBRIDA (INTELIGENTE)
        // ==========================================
        let firebaseConfig, appId, initialAuthToken;

        // A) ¿Estamos en el entorno del chat? Usar variables automáticas
        if (typeof __firebase_config !== 'undefined') {
            console.log("Modo: Entorno de Chat detectado (Configuración automática)");
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        } 
        // B) ¿Estamos en tu PC/Hosting? Usar configuración manual
        else {
            console.log("Modo: Exportación (Configuración manual activada)");
            // ✅ CONFIGURACIÓN REAL DE "PLATAFORMA CARMEN SERDÁN"
            firebaseConfig = {
                apiKey: "AIzaSyDT9M_s82TJrxwFMMFFt_M7GrQdVUFXZ2c",
                authDomain: "plataforma-carmen-serdan.firebaseapp.com",
                projectId: "plataforma-carmen-serdan",
                storageBucket: "plataforma-carmen-serdan.firebasestorage.app",
                messagingSenderId: "124079826705",
                appId: "1:124079826705:web:5e2abd11506ae24accceb0",
                measurementId: "G-VCYFS0K3BB"
            };
            // Identificador para la colección de datos
            appId = 'mirada-terapeutica-web'; 
            initialAuthToken = null;
        }
        // ==========================================

        // Inicializar Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Habilitar persistencia (funciona mejor en https)
            enableIndexedDbPersistence(db).catch(() => {}); 
        } catch (e) {
            console.error("Error inicializando Firebase. Revisa la configuración.", e);
        }

        // --- COMPONENTES ---

        const ToastContainer = ({ toasts }) => (
            <div className="fixed top-20 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                {toasts.map(toast => (
                    <div key={toast.id} className={`pointer-events-auto flex items-center gap-2 px-4 py-3 rounded-lg shadow-lg text-sm font-medium animate-fade-in ${
                        toast.type === 'error' ? 'bg-red-600 text-white' : 
                        toast.type === 'success' ? 'bg-rose-600 text-white' : 'bg-red-900 text-white'
                    }`}>
                        {toast.type === 'error' ? <AlertCircle size={16}/> : <Check size={16}/>}
                        {toast.message}
                    </div>
                ))}
            </div>
        );

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 800;
                        let { width, height } = img;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                        else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.65));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        // --- PANTALLAS ---

        const RulesModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-3xl max-w-md w-full shadow-2xl overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-6 bg-red-900 text-white flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <BookOpen size={24} />
                                <h3 className="font-serif text-xl font-bold">Reglas del Taller</h3>
                            </div>
                            <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition-colors"><X size={24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6 text-stone-700 leading-relaxed">
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">1.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Espacio Seguro</h4>
                                    <p className="text-sm">Este es un lugar libre de juicios. Comentamos desde el respeto y la empatía.</p>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">2.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Autenticidad</h4>
                                    <p className="text-sm">Comparte fotos que signifiquen algo para ti. No buscamos perfección técnica, sino honestidad emocional.</p>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">3.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Confidencialidad</h4>
                                    <p className="text-sm">Lo que se comparte en el taller, se queda en el taller. Respetamos la privacidad de las historias de los compañeros.</p>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">4.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Escucha Activa</h4>
                                    <p className="text-sm">Prestamos atención a lo que dicen las imágenes y las palabras de los demás.</p>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t border-red-50 bg-red-50/50 text-center">
                            <button onClick={onClose} className="bg-red-800 text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:bg-red-900 transition-colors w-full">
                                Entendido
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, addToast, config, currentUser, onShowRules }) => {
            const [name, setName] = useState(currentUser?.displayName || '');
            const [loading, setLoading] = useState(false);
            const [showLoginQR, setShowLoginQR] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                setLoading(true);
                try {
                    if (auth.currentUser) {
                        await updateProfile(auth.currentUser, { displayName: name });
                        onLogin();
                    } else {
                        // Intentar autenticación (custom token o anónimo)
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (err) {
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                        if (auth.currentUser) {
                             await updateProfile(auth.currentUser, { displayName: name });
                             onLogin();
                        }
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    addToast("Error de conexión. Revisa la consola.", "error");
                } finally { setLoading(false); }
            };

            const handleShare = () => {
                const url = window.location.href;
                if (navigator.share) {
                    navigator.share({ title: config.title, url }).catch(()=>{});
                } else {
                    // Fallback seguro para copiar
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = url;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        textArea.style.top = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) addToast("Enlace copiado", "success");
                        else throw new Error("Copy failed");
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                        addToast("Copia el enlace manualmente", "error");
                    }
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative z-10">
                    <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl p-8 w-full max-w-md text-center border border-white/50 animate-fade-in">
                        <div className="w-32 h-32 mx-auto mb-6 flex items-center justify-center">
                            {config.backgroundUrl ? (
                                <img src={config.backgroundUrl} className="w-full h-full object-contain drop-shadow-md" alt="Logo"/>
                            ) : (
                                <div className="w-20 h-20 rounded-2xl bg-gradient-to-tr from-red-600 to-rose-500 flex items-center justify-center text-white shadow-lg">
                                    <Camera size={40} />
                                </div>
                            )}
                        </div>
                        <h1 className="text-3xl font-serif text-red-950 mb-2">{config.title || 'Mirada Terapéutica'}</h1>
                        <p className="text-red-800/80 mb-8 text-sm font-medium">{config.subtitle || 'Espacio seguro.'}</p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" placeholder="¿Cómo te llamas?" value={name} onChange={e => setName(e.target.value)}
                                className="w-full px-4 py-4 rounded-xl border-2 border-red-50 bg-white/50 focus:outline-none focus:border-rose-400 text-center text-lg" required />
                            <button type="submit" disabled={loading} className="w-full bg-red-800 hover:bg-red-900 text-white font-medium py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                {loading ? <Loader2 className="animate-spin"/> : 'Ingresar al Taller'}
                            </button>
                        </form>
                        
                        <div className="flex flex-wrap justify-center gap-3 mt-6">
                            <button onClick={onShowRules} className="text-xs text-red-700 bg-red-100 hover:bg-red-200 flex items-center justify-center gap-2 py-2 px-4 rounded-full transition-colors font-medium w-full mb-2">
                                <BookOpen size={16} /> Reglas del Taller
                            </button>
                            <button onClick={handleShare} className="text-xs text-red-400 hover:text-red-600 flex items-center justify-center gap-2 py-2 px-4 rounded-full hover:bg-red-50 transition-colors">
                                <Share2 size={16} /> Compartir Enlace
                            </button>
                            <button onClick={() => setShowLoginQR(true)} className="text-xs text-red-400 hover:text-red-600 flex items-center justify-center gap-2 py-2 px-4 rounded-full hover:bg-red-50 transition-colors">
                                <QrCode size={16} /> Mostrar QR
                            </button>
                        </div>
                    </div>

                    {showLoginQR && (
                        <div className="fixed inset-0 z-[100] bg-red-950/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowLoginQR(false)}>
                            <div className="bg-white p-6 rounded-3xl max-w-sm w-full text-center shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="font-serif text-xl mb-4 text-red-900">Escanea para entrar</h3>
                                <div className="bg-white p-2 border border-red-100 rounded-xl inline-block mb-4 shadow-inner">
                                    <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(window.location.href)}`} alt="QR" className="w-48 h-48 mix-blend-multiply" />
                                </div>
                                <button onClick={() => setShowLoginQR(false)} className="w-full py-3 rounded-xl bg-red-50 hover:bg-red-100 text-red-900 font-bold text-sm flex items-center justify-center gap-2">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, addToast, currentConfig }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [title, setTitle] = useState('');
            const [subtitle, setSubtitle] = useState('');
            const [loading, setLoading] = useState(false);
            const [authAdmin, setAuthAdmin] = useState(false);
            const [u, setU] = useState(''); const [p, setP] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setPreview(currentConfig.backgroundUrl); setTitle(currentConfig.title); setSubtitle(currentConfig.subtitle);
                    setAuthAdmin(false); setU(''); setP('');
                }
            }, [isOpen]);

            const handleSave = async () => {
                if (!auth.currentUser) return;
                setLoading(true);
                try {
                    let url = currentConfig.backgroundUrl;
                    if (file) url = await compressImage(file);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), {
                        backgroundUrl: url, title, subtitle, updatedAt: serverTimestamp()
                    }, { merge: true });
                    addToast("Guardado", "success"); onClose();
                } catch(e) { console.error(e); addToast("Error guardando", "error"); } finally { setLoading(false); }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (u === 'ADMIN' && p === 'ADMIN123') { setAuthAdmin(true); addToast("Acceso correcto", "success"); }
                else addToast("Credenciales incorrectas", "error");
            }

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="flex justify-between p-6 border-b border-red-50">
                            <h3 className="text-xl font-serif text-red-900">{authAdmin ? 'Personalizar' : 'Admin'}</h3>
                            <button onClick={onClose}><X className="text-red-300"/></button>
                        </div>
                        {!authAdmin ? (
                            <form onSubmit={handleLogin} className="p-8 flex flex-col gap-4 text-center">
                                <Lock className="w-12 h-12 text-red-500 mx-auto mb-2"/>
                                <p className="text-sm text-red-400">Área restringida</p>
                                <input type="text" placeholder="Usuario" value={u} onChange={e=>setU(e.target.value)} className="p-3 rounded-xl border border-red-100 text-center"/>
                                <input type="password" placeholder="Contraseña" value={p} onChange={e=>setP(e.target.value)} className="p-3 rounded-xl border border-red-100 text-center"/>
                                <button className="bg-red-800 text-white py-3 rounded-xl">Entrar</button>
                            </form>
                        ) : (
                            <div className="p-6 space-y-6 overflow-y-auto">
                                <div className="space-y-3">
                                    <label className="text-xs text-red-400">Título</label>
                                    <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-3 bg-red-50 rounded-xl border-red-100 border"/>
                                    <label className="text-xs text-red-400">Subtítulo</label>
                                    <textarea value={subtitle} onChange={e=>setSubtitle(e.target.value)} className="w-full p-3 bg-red-50 rounded-xl border-red-100 border h-20"/>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs text-red-400">Logo / Fondo</label>
                                    <label className="block w-full h-32 border-2 border-dashed border-red-200 rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden">
                                        {preview ? <img src={preview} className="h-full object-contain"/> : <ImageIcon className="text-red-300"/>}
                                        <input type="file" className="hidden" onChange={e => {
                                            const f = e.target.files[0];
                                            if(f) { setFile(f); const r = new FileReader(); r.onload=()=>setPreview(r.result); r.readAsDataURL(f); }
                                        }}/>
                                    </label>
                                    {preview && <button onClick={async ()=>{
                                        if(confirm("¿Borrar fondo?")) {
                                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), { backgroundUrl: null }, { merge: true });
                                            setPreview(null);
                                        }
                                    }} className="text-xs text-red-500 flex items-center gap-1"><Trash2 size={12}/> Quitar fondo</button>}
                                </div>
                                <button onClick={handleSave} disabled={loading} className="w-full bg-red-800 text-white py-3 rounded-xl flex justify-center gap-2">
                                    {loading ? <Loader2 className="animate-spin"/> : 'Guardar Cambios'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [hasEntered, setHasEntered] = useState(false);
            const [toasts, setToasts] = useState([]);
            const [photos, setPhotos] = useState([]);
            const [config, setConfig] = useState({ title: 'Mirada Terapéutica', subtitle: 'Bienvenido' });
            const [showUpload, setShowUpload] = useState(false);
            const [showConfig, setShowConfig] = useState(false);
            const [showRules, setShowRules] = useState(false);
            const [showViewer, setShowViewer] = useState(null);
            
            // Toast Helper
            const addToast = (msg, type='info') => {
                const id = Date.now(); setToasts(p => [...p, {id, message: msg, type}]);
                setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
            };

            // Auth Logic (MANDATORIO PARA QUE FUNCIONE EN CHAT Y EXPORT)
            useEffect(() => {
                const initAuth = async () => {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.warn("Token inicial falló, probando anónimo", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                
                return onAuthStateChanged(auth, u => {
                    setUser(u);
                });
            }, []);

            // Data Sync (Solo carga si hay usuario)
            useEffect(() => {
                if (!user) return;
                
                // Cargar Fotos
                const unsubPhotos = onSnapshot(
                    query(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), orderBy('createdAt', 'desc')), 
                    s => setPhotos(s.docs.map(d => ({id: d.id, ...d.data()}))),
                    err => console.error("Error fotos:", err)
                );
                
                // Cargar Configuración (Logo, Titulo)
                const unsubConfig = onSnapshot(
                    doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), 
                    s => { if(s.exists()) setConfig(prev => ({...prev, ...s.data()})); },
                    err => console.error("Error config:", err)
                );
                
                return () => { unsubPhotos(); unsubConfig(); };
            }, [user]);

            const toggleLike = async (photo) => {
                if(!user) return;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'workshop_photos', photo.id);
                const liked = photo.likes?.includes(user.uid);
                await updateDoc(ref, { likes: liked ? arrayRemove(user.uid) : arrayUnion(user.uid) });
            };

            const deletePhoto = async (id) => {
                if(confirm("¿Eliminar?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'workshop_photos', id)); setShowViewer(null); addToast("Eliminado", "success"); }
            };

            // Upload Logic
            const [upFile, setUpFile] = useState(null);
            const [upDesc, setUpDesc] = useState('');
            const [isUp, setIsUp] = useState(false);
            const [upPreview, setUpPreview] = useState(null);

            const handleUploadConfirm = async () => {
                if(!upFile || !user) return;
                setIsUp(true);
                try {
                    const b64 = await compressImage(upFile);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), {
                        imageUrl: b64, description: upDesc, photographerName: user.displayName, photographerId: user.uid,
                        likes: [], createdAt: serverTimestamp()
                    });
                    addToast("Subido", "success"); setShowUpload(false); setUpFile(null); setUpPreview(null); setUpDesc('');
                } catch(e) { console.error(e); addToast("Error al subir", "error"); } finally { setIsUp(false); }
            };

            if (!user) return <div className="h-screen flex items-center justify-center bg-rose-50 text-red-400"><Loader2 className="animate-spin" size={40}/></div>;

            return (
                <div className="min-h-screen relative font-sans" style={{backgroundColor: '#FEF2F2'}}>
                    <div className="fixed inset-0 pointer-events-none transition-all duration-700 z-0"
                         style={{ backgroundImage: config.backgroundUrl ? `url(${config.backgroundUrl})` : 'none', 
                                  backgroundPosition: 'center', backgroundRepeat: 'no-repeat', backgroundSize: '50%', opacity: 0.15 }} />
                    
                    <ToastContainer toasts={toasts} />

                    {!hasEntered ? (
                        <LoginScreen 
                            onLogin={() => setHasEntered(true)} 
                            addToast={addToast} 
                            config={config} 
                            currentUser={user} 
                            onShowRules={() => setShowRules(true)}
                        />
                    ) : (
                        <>
                            {/* Header */}
                            <header className="fixed top-0 inset-x-0 bg-white/80 backdrop-blur-md border-b border-red-50 z-40 p-3 flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-rose-700 flex items-center justify-center text-white"><Camera size={16}/></div>
                                    <h1 className="font-serif font-bold text-red-950 truncate max-w-[150px]">{config.title}</h1>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>setShowRules(true)} className="p-2 hover:bg-red-50 rounded-full text-red-800" title="Ver Reglas"><BookOpen size={20}/></button>
                                    <button onClick={()=>setShowConfig(true)} className="p-2 hover:bg-red-50 rounded-full text-red-800"><Settings size={20}/></button>
                                    <button onClick={()=>confirm("¿Salir?") && window.location.reload()} className="p-2 hover:bg-red-50 rounded-full text-red-800"><LogOut size={20}/></button>
                                </div>
                            </header>

                            {/* Gallery */}
                            <main className="pt-20 pb-24 px-4 max-w-6xl mx-auto">
                                {photos.length === 0 ? (
                                    <div className="text-center py-20 text-red-300">
                                        <ImageIcon size={48} className="mx-auto mb-4"/>
                                        <p>No hay momentos aún.</p>
                                    </div>
                                ) : (
                                    <div className="columns-2 md:columns-3 gap-4 space-y-4">
                                        {photos.map(p => (
                                            <div key={p.id} onClick={()=>setShowViewer(p)} className="break-inside-avoid bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer">
                                                <img src={p.imageUrl} className="w-full h-auto"/>
                                                <div className="p-3">
                                                    <p className="text-xs text-stone-600 line-clamp-2 italic mb-2">"{p.description}"</p>
                                                    <div className="flex justify-between items-center text-[10px] text-red-400 font-bold uppercase">
                                                        <span>{p.photographerName}</span>
                                                        {p.likes?.length > 0 && <span className="flex items-center gap-1"><Heart size={10} className="fill-red-500 text-red-500"/> {p.likes.length}</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </main>

                            {/* FAB */}
                            <button onClick={()=>setShowUpload(true)} className="fixed bottom-6 right-6 z-40 bg-red-800 text-white p-4 rounded-full shadow-xl flex items-center gap-2 hover:scale-105 transition-transform">
                                <Camera size={24}/> <span className="font-bold text-sm">Capturar</span>
                            </button>

                            {/* Upload Modal */}
                            {showUpload && (
                                <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
                                    <div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col overflow-hidden">
                                        <div className="p-4 border-b flex justify-between">
                                            <h3 className="font-bold text-red-900">Nueva Foto</h3>
                                            <button onClick={()=>{setShowUpload(false); setUpFile(null); setUpPreview(null);}}><X/></button>
                                        </div>
                                        <div className="flex-1 p-4 overflow-y-auto space-y-4">
                                            {!upPreview ? (
                                                <label className="h-40 border-2 border-dashed border-red-200 rounded-xl flex items-center justify-center text-red-400 flex-col cursor-pointer">
                                                    <Camera size={32} className="mb-2"/> Toca para elegir
                                                    <input type="file" className="hidden" accept="image/*" onChange={e=>{
                                                        const f = e.target.files[0]; if(f){setUpFile(f); const r=new FileReader();r.onload=()=>setUpPreview(r.result);r.readAsDataURL(f);}
                                                    }}/>
                                                </label>
                                            ) : (
                                                <div className="relative">
                                                    <img src={upPreview} className="rounded-xl w-full"/>
                                                    <button onClick={()=>{setUpPreview(null); setUpFile(null)}} className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"><X size={16}/></button>
                                                </div>
                                            )}
                                            <div className="relative">
                                                <textarea value={upDesc} onChange={e=>setUpDesc(e.target.value)} placeholder="¿Qué te hizo detenerte a mirar esta foto?" className="w-full p-4 bg-red-50 rounded-xl h-32"/>
                                            </div>
                                        </div>
                                        <div className="p-4 border-t">
                                            <button onClick={handleUploadConfirm} disabled={!upFile || isUp} className="w-full bg-red-800 text-white py-3 rounded-xl font-bold flex justify-center gap-2">
                                                {isUp ? <Loader2 className="animate-spin"/> : <>Compartir <Send size={18}/></>}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Viewer Modal */}
                            {showViewer && (
                                <div className="fixed inset-0 z-[90] bg-black flex items-center justify-center p-4" onClick={()=>setShowViewer(null)}>
                                    <button className="absolute top-4 right-4 text-white p-2"><X size={32}/></button>
                                    {user.uid === showViewer.photographerId && <button onClick={(e)=>{e.stopPropagation(); deletePhoto(showViewer.id)}} className="absolute top-4 left-4 text-white p-2"><Trash2/></button>}
                                    <div className="max-w-full max-h-full overflow-y-auto text-center" onClick={e=>e.stopPropagation()}>
                                        <img src={showViewer.imageUrl} className="max-h-[70vh] mx-auto rounded shadow-2xl"/>
                                        <p className="text-white mt-4 font-serif italic text-xl">"{showViewer.description}"</p>
                                        <p className="text-stone-400 text-sm mt-2 uppercase tracking-widest">{showViewer.photographerName}</p>
                                        <button onClick={()=>toggleLike(showViewer)} className={`mt-4 px-6 py-2 rounded-full flex items-center gap-2 mx-auto ${showViewer.likes?.includes(user.uid) ? 'bg-red-600 text-white' : 'bg-white/20 text-white'}`}>
                                            <Heart size={20} className={showViewer.likes?.includes(user.uid) ? 'fill-white' : ''}/>
                                            {showViewer.likes?.length || 0}
                                        </button>
                                    </div>
                                </div>
                            )}

                            <ConfigModal isOpen={showConfig} onClose={()=>setShowConfig(false)} addToast={addToast} currentConfig={config} />
                        </>
                    )}
                    
                    <RulesModal isOpen={showRules} onClose={() => setShowRules(false)} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
