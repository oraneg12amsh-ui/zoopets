<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirada TerapÃ©utica</title>
    
    <!-- 1. Tailwind CSS (DiseÃ±o) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Motor de la App) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            background-color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-rose-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signOut, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, setDoc, arrayUnion, arrayRemove, onSnapshot, serverTimestamp, query, orderBy, enableIndexedDbPersistence } from 'firebase/firestore';
        import { Camera, Send, X, QrCode, Heart, Image as ImageIcon, Loader2, WifiOff, Copy, Check, Trash2, LogOut, AlertCircle, Info, Settings, Type, Sparkles, Lock, Share2, BookOpen, ChevronLeft, ChevronRight, Timer, Play, Pause, RotateCcw, Minimize2, Palette, Lightbulb, Reply, Users, Shuffle } from 'lucide-react';

        // --- CONFIGURACIÃ“N ---
        let firebaseConfig, appId, initialAuthToken;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyDT9M_s82TJrxwFMMFFt_M7GrQdVUFXZ2c",
                authDomain: "plataforma-carmen-serdan.firebaseapp.com",
                projectId: "plataforma-carmen-serdan",
                storageBucket: "plataforma-carmen-serdan.firebasestorage.app",
                messagingSenderId: "124079826705",
                appId: "1:124079826705:web:5e2abd11506ae24accceb0",
                measurementId: "G-VCYFS0K3BB"
            };
            appId = 'mirada-terapeutica-web'; 
            initialAuthToken = null;
        }

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            enableIndexedDbPersistence(db).catch(() => {}); 
        } catch (e) { console.error(e); }

        const REACTION_MAP = [
            { icon: 'â¤', field: 'likes', color: 'text-rose-600 bg-rose-50 border-rose-200 ring-1 ring-rose-200' },
            { icon: 'ðŸ¤£', field: 'likes_funny', color: 'text-amber-600 bg-amber-50 border-amber-200 ring-1 ring-amber-200' },
            { icon: 'ðŸ˜', field: 'likes_love', color: 'text-fuchsia-600 bg-fuchsia-50 border-fuchsia-200 ring-1 ring-fuchsia-200' },
            { icon: 'ðŸ˜±', field: 'likes_shock', color: 'text-cyan-600 bg-cyan-50 border-cyan-200 ring-1 ring-cyan-200' },
            { icon: 'ðŸ¤¡', field: 'likes_clown', color: 'text-purple-600 bg-purple-50 border-purple-200 ring-1 ring-purple-200' },
            { icon: 'ðŸ¤­', field: 'likes_giggle', color: 'text-orange-600 bg-orange-50 border-orange-200 ring-1 ring-orange-200' }
        ];

        const FILTERS = {
            normal: { name: 'Normal', filter: 'none' },
            bw: { name: 'B/N', filter: 'grayscale(100%)' },
            sepia: { name: 'CÃ¡lido', filter: 'sepia(60%) contrast(110%)' },
            vivid: { name: 'VÃ­vido', filter: 'saturate(150%) contrast(110%)' },
            cool: { name: 'FrÃ­o', filter: 'hue-rotate(180deg) sepia(20%)' } 
        };

        const MOODS = [
            { label: "Calma", emoji: "ðŸ˜Œ", color: "bg-teal-100 text-teal-800 border-teal-200" },
            { label: "AlegrÃ­a", emoji: "ðŸ˜„", color: "bg-yellow-100 text-yellow-800 border-yellow-200" },
            { label: "Nostalgia", emoji: "ðŸ‚", color: "bg-orange-100 text-orange-800 border-orange-200" },
            { label: "Esperanza", emoji: "ðŸŒŸ", color: "bg-sky-100 text-sky-800 border-sky-200" },
            { label: "Tristeza", emoji: "ðŸ’§", color: "bg-indigo-100 text-indigo-800 border-indigo-200" },
            { label: "Gratitud", emoji: "ðŸ™", color: "bg-rose-100 text-rose-800 border-rose-200" }
        ];

        const INSPIRATION_PROMPTS = [
            "Busca una textura que te transmita paz.",
            "FotografÃ­a algo que haya cambiado con el tiempo.",
            "Encuentra belleza en lo ordinario.",
            "Captura un rayo de luz o una sombra interesante.",
            "Busca el color que represente tu estado de Ã¡nimo hoy.",
            "FotografÃ­a algo frÃ¡gil o delicado.",
            "Encuentra un patrÃ³n en la naturaleza.",
            "Captura un momento de silencio.",
            "FotografÃ­a algo que te haga sonreÃ­r.",
            "Busca contrastes: viejo/nuevo, luz/sombra."
        ];

        // --- 70 RETOS DE DÃšO ---
        const DUO_CHALLENGES = [
            "FotografÃ­a a tu pareja cuando estÃ¡ triste.",
            "Haz la cara cuando te enojas con tus papÃ¡s.",
            "Tu mejor sonrisa fingida.",
            "Cara de haber olido algo feo.",
            "ExpresiÃ³n de 'se me olvidÃ³ la cartulina'.",
            "Tu cara cuando ves a tu crush.",
            "FotografÃ­a cuando vas a visitar a tu suegra (cara de pÃ¡nico).",
            "Cara de no soportar a nadie hoy.",
            "Tu expresiÃ³n cuando repruebas un examen.",
            "Tu cara cuando te dan un regalo que no te gusta.",
            "ExpresiÃ³n de haber ganado la loterÃ­a.",
            "Cara de susto extremo.",
            "Tu mejor cara de modelo profesional.",
            "Cara de estar aguantando la risa.",
            "ExpresiÃ³n de aburrimiento total en clase.",
            "Tu cara cuando te cuentan un chisme bueno.",
            "Cara de dolor de estÃ³mago.",
            "ExpresiÃ³n de victoria.",
            "Tu cara de reciÃ©n levantado.",
            "Cara de haber comido limÃ³n.",
            "ExpresiÃ³n de ternura mÃ¡xima.",
            "Tu cara cuando no entiendes la tarea.",
            "Cara de 'yo no fui'.",
            "ExpresiÃ³n de orgullo.",
            "Tu cara cuando ves comida deliciosa.",
            "Cara de confusiÃ³n total.",
            "ExpresiÃ³n de miedo a las alturas.",
            "Tu cara cuando te cachan en una mentira.",
            "Cara de estar tramando algo.",
            "ExpresiÃ³n de serenidad absoluta.",
            "Tu cara cantando tu canciÃ³n favorita.",
            "Cara de estar perdido en la ciudad.",
            "ExpresiÃ³n de asco.",
            "Tu cara cuando te pica un mosquito.",
            "Cara de estar viendo una pelÃ­cula de terror.",
            "ExpresiÃ³n de sorpresa genuina.",
            "Tu cara de 'te lo dije'.",
            "Cara de estar muy cansado.",
            "ExpresiÃ³n de esperanza.",
            "Tu cara cuando te encuentras dinero.",
            "Cara de estar regaÃ±ando a alguien.",
            "ExpresiÃ³n de sÃºplica.",
            "Tu cara de valentÃ­a.",
            "Cara de estar congelado de frÃ­o.",
            "ExpresiÃ³n de estar derritiÃ©ndose de calor.",
            "Tu cara cuando se va el internet.",
            "Cara de estar concentrado leyendo.",
            "ExpresiÃ³n de incredulidad.",
            "Tu cara cuando ves un perro lindo.",
            "Cara de estar probando algo picante.",
            "ExpresiÃ³n de alivio.",
            "Tu cara de 'trÃ¡game tierra'.",
            "Cara de estar posando para una foto familiar obligada.",
            "ExpresiÃ³n de curiosidad.",
            "Tu cara cuando te despiertan temprano.",
            "Cara de estar planeando una broma.",
            "ExpresiÃ³n de timidez.",
            "Tu cara de locura temporal.",
            "Cara de estar meditando.",
            "ExpresiÃ³n de frustraciÃ³n con la tecnologÃ­a.",
            "Tu cara cuando te dicen un piropo.",
            "Cara de estar oliendo flores.",
            "ExpresiÃ³n de determinaciÃ³n.",
            "Tu cara cuando te pegas en el dedo chiquito del pie.",
            "Cara de estar viendo llover.",
            "ExpresiÃ³n de nostalgia.",
            "Tu cara de 'no me importa'.",
            "Cara de estar escuchando mÃºsica triste.",
            "ExpresiÃ³n de envidia (de la buena).",
            "Tu cara cuando por fin terminas la tarea."
        ];

        const ToastContainer = ({ toasts }) => (
            <div className="fixed top-24 right-4 z-[100] flex flex-col gap-3 pointer-events-none">
                {toasts.map(toast => (
                    <div key={toast.id} className={`pointer-events-auto flex items-center gap-3 px-5 py-3.5 rounded-2xl shadow-xl backdrop-blur-md border border-white/20 text-sm font-medium animate-fade-in ${
                        toast.type === 'error' ? 'bg-red-500/90 text-white' : 
                        toast.type === 'success' ? 'bg-emerald-500/90 text-white' : 'bg-slate-800/90 text-white'
                    }`}>
                        {toast.type === 'error' ? <AlertCircle size={18}/> : <Check size={18}/>}
                        {toast.message}
                    </div>
                ))}
            </div>
        );

        const processImage = (file, filterType = 'normal') => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 1000;
                        let { width, height } = img;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                        else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        if (filterType !== 'normal') ctx.filter = FILTERS[filterType].filter;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const Stopwatch = () => {
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);

            useEffect(() => {
                let interval;
                if (isRunning) interval = setInterval(() => setTime(t => t + 1), 1000);
                return () => clearInterval(interval);
            }, [isRunning]);

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };

            if (!isExpanded) {
                return (
                    <button onClick={() => setIsExpanded(true)} className="fixed bottom-6 left-6 z-40 bg-white/90 backdrop-blur-md text-slate-700 p-4 rounded-full shadow-2xl flex items-center gap-2 hover:scale-105 transition-all border border-slate-200/50 hover:border-fuchsia-300 group">
                        <Timer size={24} className="group-hover:text-fuchsia-600 transition-colors" />
                        {time > 0 && <span className="font-bold font-mono text-sm text-slate-900">{formatTime(time)}</span>}
                    </button>
                );
            }

            return (
                <div className="fixed inset-0 z-[120] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in">
                    <div className="flex flex-col items-center w-full max-w-lg text-center">
                        <div className="text-slate-400 font-medium tracking-widest uppercase text-sm mb-8">Tiempo de Actividad</div>
                        <div className="text-white font-mono text-9xl font-bold mb-12 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)] tabular-nums tracking-widest bg-clip-text text-transparent bg-gradient-to-b from-white to-slate-400">{formatTime(time)}</div>
                        <div className="flex gap-8 mb-16">
                            <button onClick={() => setIsRunning(!isRunning)} className="bg-white text-slate-900 p-8 rounded-full shadow-[0_0_40px_rgba(255,255,255,0.1)] hover:scale-110 active:scale-95 transition-all duration-300 hover:shadow-[0_0_60px_rgba(255,255,255,0.2)]">
                                {isRunning ? <Pause size={48} fill="currentColor" /> : <Play size={48} fill="currentColor" className="ml-2" />}
                            </button>
                            <button onClick={() => { setIsRunning(false); setTime(0); }} className="bg-slate-800 text-white p-8 rounded-full border border-slate-700 hover:bg-rose-600 hover:border-rose-500 active:scale-95 transition-all duration-300">
                                <RotateCcw size={48} />
                            </button>
                        </div>
                        <button onClick={() => setIsExpanded(false)} className="text-white/60 hover:text-white flex items-center gap-2 py-3 px-6 rounded-full hover:bg-white/10 transition-colors">
                            <Minimize2 size={20} /> Minimizar
                        </button>
                    </div>
                </div>
            );
        };

        const InspirationModal = ({ isOpen, onClose }) => {
            const [prompt, setPrompt] = useState("");
            useEffect(() => { if(isOpen) setPrompt(INSPIRATION_PROMPTS[Math.floor(Math.random() * INSPIRATION_PROMPTS.length)]); }, [isOpen]);
            if (!isOpen) return null;
            return ( <div className="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}> <div className="bg-white rounded-[2rem] max-w-md w-full shadow-2xl overflow-hidden flex flex-col p-8 text-center relative" onClick={e => e.stopPropagation()}> <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-rose-400 to-fuchsia-500"></div> <div className="mb-6 flex justify-center"> <div className="bg-yellow-100 p-4 rounded-full shadow-inner"> <Lightbulb size={40} className="text-yellow-600 fill-yellow-600 animate-pulse" /> </div> </div> <h3 className="text-slate-900 font-bold text-xl mb-4">Tu Reto de Hoy</h3> <p className="text-slate-600 text-lg font-medium leading-relaxed mb-8">"{prompt}"</p> <div className="flex gap-3"> <button onClick={() => setPrompt(INSPIRATION_PROMPTS[Math.floor(Math.random() * INSPIRATION_PROMPTS.length)])} className="flex-1 py-3 rounded-xl border border-slate-200 text-slate-600 font-medium hover:bg-slate-50">Otro Reto</button> <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-slate-900 text-white font-medium hover:bg-black">Aceptar</button> </div> </div> </div> );
        };

        // ... [LoginScreen, ConfigModal, RulesModal codes remain identical to previous versions, just injecting into final assembly] ...
        const LoginScreen = ({ onLogin, addToast, config, currentUser, onShowRules }) => {
            const [name, setName] = useState(currentUser?.displayName || '');
            const [loading, setLoading] = useState(false);
            const [showLoginQR, setShowLoginQR] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                setLoading(true);
                try {
                    if (auth.currentUser) { await updateProfile(auth.currentUser, { displayName: name }); onLogin(); } 
                    else {
                        if (initialAuthToken) try { await signInWithCustomToken(auth, initialAuthToken); } catch (err) { await signInAnonymously(auth); }
                        else await signInAnonymously(auth);
                        if (auth.currentUser) { await updateProfile(auth.currentUser, { displayName: name }); onLogin(); }
                    }
                } catch (error) { addToast("Error de conexiÃ³n.", "error"); } finally { setLoading(false); }
            };
            const handleShare = () => {
                const url = window.location.href;
                if (navigator.share) navigator.share({ title: config.title, url }).catch(()=>{});
                else { navigator.clipboard.writeText(url).then(() => addToast("Copiado", "success")).catch(() => addToast("Error al copiar", "error")); }
            };
            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative z-10 overflow-hidden">
                    <div className="bg-white/80 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_20px_60px_-15px_rgba(0,0,0,0.1)] p-10 w-full max-w-md text-center border border-white/60 animate-fade-in relative z-10">
                        <div className="w-32 h-32 mx-auto mb-8 flex items-center justify-center relative group">
                            <div className="absolute inset-0 bg-gradient-to-tr from-red-500 to-rose-500 rounded-full blur-2xl opacity-40 group-hover:opacity-60 transition-opacity duration-500"></div>
                            <div className="relative z-10 w-full h-full p-2">
                                {config.backgroundUrl ? ( <img src={config.backgroundUrl} className="w-full h-full object-contain drop-shadow-xl" alt="Logo"/> ) : ( <div className="w-full h-full rounded-3xl bg-gradient-to-br from-red-600 to-rose-600 flex items-center justify-center text-white"><Camera size={48} /></div> )}
                            </div>
                        </div>
                        <h1 className="text-4xl font-black text-slate-800 mb-3 tracking-tight">{config.title || 'Mirada TerapÃ©utica'}</h1>
                        <p className="text-slate-500 mb-10 text-base font-medium">{config.subtitle || 'Espacio seguro.'}</p>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <input type="text" placeholder="Â¿CÃ³mo te llamas?" value={name} onChange={e => setName(e.target.value)} className="w-full px-6 py-4.5 rounded-2xl border border-slate-200 bg-white/80 focus:outline-none focus:border-red-500 focus:ring-4 focus:ring-red-500/10 text-center text-lg font-medium transition-all text-slate-800" required />
                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-700 hover:to-rose-700 text-white font-bold py-4.5 rounded-2xl shadow-xl shadow-rose-500/20 flex items-center justify-center gap-3 active:scale-[0.98] transition-all">
                                {loading ? <Loader2 className="animate-spin"/> : <><span>Ingresar</span> <ChevronRight size={18} opacity={0.8}/></>}
                            </button>
                        </form>
                        <div className="flex flex-wrap justify-center gap-3 mt-10">
                            <button onClick={onShowRules} className="text-xs font-bold text-rose-700 bg-rose-50 hover:bg-rose-100 flex items-center justify-center gap-2 py-2.5 px-5 rounded-full w-full mb-1 border border-rose-100"><BookOpen size={16} /> Reglas del Taller</button>
                            <div className="flex gap-3 w-full justify-center">
                                <button onClick={handleShare} className="text-xs font-medium text-slate-500 hover:text-slate-800 flex items-center justify-center gap-2 py-2.5 px-5 rounded-full hover:bg-slate-100 transition-colors border border-transparent hover:border-slate-200"><Share2 size={16} /> Compartir</button>
                                <button onClick={() => setShowLoginQR(true)} className="text-xs font-medium text-slate-500 hover:text-slate-800 flex items-center justify-center gap-2 py-2.5 px-5 rounded-full hover:bg-slate-100 transition-colors border border-transparent hover:border-slate-200"><QrCode size={16} /> QR</button>
                            </div>
                        </div>
                    </div>
                    {showLoginQR && ( <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowLoginQR(false)}> <div className="bg-white p-8 rounded-[2rem] max-w-sm w-full text-center shadow-2xl" onClick={e => e.stopPropagation()}> <h3 className="font-bold text-2xl mb-6 text-slate-800">Escanea para entrar</h3> <div className="bg-white p-4 border-2 border-dashed border-slate-200 rounded-3xl inline-block mb-8 shadow-sm"> <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(window.location.href)}`} alt="QR" className="w-56 h-56 mix-blend-multiply" /> </div> <button onClick={() => setShowLoginQR(false)} className="w-full py-3.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold text-sm">Cerrar</button> </div> </div> )}
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, addToast, currentConfig }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [title, setTitle] = useState('');
            const [subtitle, setSubtitle] = useState('');
            const [loading, setLoading] = useState(false);
            const [authAdmin, setAuthAdmin] = useState(false);
            const [u, setU] = useState(''); const [p, setP] = useState('');
            useEffect(() => { if (isOpen) { setPreview(currentConfig.backgroundUrl); setTitle(currentConfig.title); setSubtitle(currentConfig.subtitle); setAuthAdmin(false); setU(''); setP(''); } }, [isOpen]);
            const handleSave = async () => { if (!auth.currentUser) return; setLoading(true); try { let url = currentConfig.backgroundUrl; if (file) url = await processImage(file, 'normal'); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), { backgroundUrl: url, title, subtitle, updatedAt: serverTimestamp() }, { merge: true }); addToast("Guardado", "success"); onClose(); } catch(e) { addToast("Error", "error"); } finally { setLoading(false); } };
            const handleLogin = (e) => { e.preventDefault(); if (u === 'ADMIN' && p === 'ADMIN123') { setAuthAdmin(true); addToast("Acceso correcto", "success"); } else addToast("Credenciales incorrectas", "error"); };
            if (!isOpen) return null;
            return ( <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in"> <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-white/50"> <div className="flex justify-between p-6 border-b border-slate-100 bg-slate-50/50"> <h3 className="text-xl font-bold text-slate-800">{authAdmin ? 'Personalizar' : 'Admin'}</h3> <button onClick={onClose}><X size={20}/></button> </div> {!authAdmin ? ( <form onSubmit={handleLogin} className="p-10 flex flex-col gap-5 text-center"> <Lock className="w-10 h-10 text-slate-400 mx-auto mb-2"/> <input type="text" placeholder="Usuario" value={u} onChange={e=>setU(e.target.value)} className="p-4 rounded-xl border border-slate-200 bg-slate-50 text-center"/> <input type="password" placeholder="ContraseÃ±a" value={p} onChange={e=>setP(e.target.value)} className="p-4 rounded-xl border border-slate-200 bg-slate-50 text-center"/> <button className="bg-slate-900 text-white py-4 rounded-xl font-bold">Entrar</button> </form> ) : ( <div className="p-8 space-y-8 overflow-y-auto"> <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-4 bg-slate-50 rounded-xl border border-slate-200" placeholder="TÃ­tulo"/> <textarea value={subtitle} onChange={e=>setSubtitle(e.target.value)} className="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 h-24" placeholder="SubtÃ­tulo"/> <label className="block w-full h-40 border-2 border-dashed border-slate-300 rounded-2xl flex items-center justify-center cursor-pointer relative bg-slate-50"> {preview ? <img src={preview} className="h-full object-contain p-4"/> : <ImageIcon size={32} className="text-slate-300"/>} <input type="file" className="hidden" onChange={e => { const f = e.target.files[0]; if(f) { setFile(f); const r = new FileReader(); r.onload=()=>setPreview(r.result); r.readAsDataURL(f); } }}/> </label> <button onClick={handleSave} disabled={loading} className="w-full bg-rose-600 text-white py-4 rounded-xl font-bold">Guardar</button> </div> )} </div> </div> );
        };

        const RulesModal = ({ isOpen, onClose }) => { if (!isOpen) return null; return ( <div className="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}> <div className="bg-white rounded-3xl max-w-md w-full shadow-2xl overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}> <div className="p-6 bg-gradient-to-r from-rose-700 to-fuchsia-700 text-white flex justify-between items-center"> <h3 className="font-bold text-lg">Reglas</h3> <button onClick={onClose}><X size={20}/></button> </div> <div className="p-8 space-y-4 overflow-y-auto text-slate-600"> <p>1. Espacio Seguro</p> <p>2. Autenticidad</p> <p>3. Confidencialidad</p> </div> <div className="p-6 border-t"><button onClick={onClose} className="bg-slate-900 text-white w-full py-3 rounded-xl">Entendido</button></div> </div> </div> ); };

        const DuoUploadModal = ({ isOpen, onClose, userId, userName, addToast }) => {
            const [step, setStep] = useState(1);
            const [challengeA, setChallengeA] = useState('');
            const [photoA, setPhotoA] = useState(null);
            const [challengeB, setChallengeB] = useState('');
            const [photoB, setPhotoB] = useState(null);
            const [uploading, setUploading] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    setStep(1); setChallengeA(''); setPhotoA(null); setChallengeB(''); setPhotoB(null); setUploading(false);
                }
            }, [isOpen]);

            const generateChallenge = (isA) => {
                const random = DUO_CHALLENGES[Math.floor(Math.random() * DUO_CHALLENGES.length)];
                if (isA) setChallengeA(random); else setChallengeB(random);
            };

            const handleFile = (e, isA) => {
                const f = e.target.files[0];
                if (f) {
                    const r = new FileReader();
                    r.onload = () => isA ? setPhotoA(r.result) : setPhotoB(r.result);
                    r.readAsDataURL(f);
                }
            };

            const handleFinalUpload = async () => {
                setUploading(true);
                try {
                    // Upload as a single "duo" type document
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), {
                        type: 'duo',
                        imgA: photoA, challengeA,
                        imgB: photoB, challengeB,
                        photographerName: userName, photographerId: userId,
                        likes: [], likes_funny: [], likes_love: [], likes_shock: [], likes_clown: [], likes_giggle: [],
                        createdAt: serverTimestamp(),
                        description: "Reto DÃºo Completado" // Generic description for listing
                    });
                    addToast("Â¡Reto DÃºo compartido!", "success");
                    onClose();
                } catch (e) { console.error(e); addToast("Error al subir", "error"); }
                finally { setUploading(false); }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[80] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-[2rem] w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl border border-white/50">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-bold text-lg text-indigo-800 flex items-center gap-2">
                                <Users size={20}/> Reto de DÃºos - Paso {step < 3 ? '1 (Jugador A)' : '2 (Jugador B)'}
                            </h3>
                            <button onClick={onClose}><X size={20}/></button>
                        </div>
                        
                        <div className="flex-1 p-6 overflow-y-auto bg-slate-50/30">
                            <div className="flex flex-col md:flex-row gap-6 h-full">
                                {/* CARD JUGADOR A */}
                                <div className={`flex-1 bg-white p-6 rounded-3xl shadow-sm border-2 ${step >= 3 ? 'border-green-200 opacity-50' : 'border-indigo-100'}`}>
                                    <h4 className="font-bold text-slate-400 text-xs uppercase tracking-widest mb-4">Jugador 1</h4>
                                    
                                    {!photoA ? (
                                        <>
                                            <div className="bg-indigo-50 p-6 rounded-2xl mb-6 text-center min-h-[120px] flex items-center justify-center">
                                                {challengeA ? <p className="text-indigo-900 font-bold text-lg">"{challengeA}"</p> : <p className="text-indigo-300">Genera un reto para comenzar</p>}
                                            </div>
                                            <button onClick={()=>generateChallenge(true)} className="w-full py-3 rounded-xl border-2 border-indigo-100 text-indigo-600 font-bold mb-4 hover:bg-indigo-50 transition-colors">GENERAR RETO</button>
                                            
                                            {challengeA && (
                                                <label className="block w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-center cursor-pointer hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200">
                                                    <Camera className="inline mr-2" size={20}/> CAPTURAR
                                                    <input type="file" className="hidden" accept="image/*" capture="environment" onChange={(e)=>handleFile(e, true)}/>
                                                </label>
                                            )}
                                        </>
                                    ) : (
                                        <div className="relative rounded-2xl overflow-hidden">
                                            <img src={photoA} className="w-full h-48 object-cover"/>
                                            <div className="absolute bottom-0 w-full bg-black/60 p-2 text-white text-xs text-center backdrop-blur-sm">
                                                {challengeA}
                                            </div>
                                            {step < 3 && <button onClick={()=>setStep(3)} className="absolute inset-0 bg-black/20 flex items-center justify-center text-white font-bold text-xl backdrop-blur-sm hover:bg-black/10 transition-colors">Siguiente Turno â†’</button>}
                                        </div>
                                    )}
                                </div>

                                {/* CARD JUGADOR B */}
                                <div className={`flex-1 bg-white p-6 rounded-3xl shadow-sm border-2 ${step < 3 ? 'border-slate-100 opacity-50 pointer-events-none' : 'border-fuchsia-100'}`}>
                                    <h4 className="font-bold text-slate-400 text-xs uppercase tracking-widest mb-4">Jugador 2</h4>
                                    
                                    {step >= 3 && !photoB ? (
                                        <>
                                            <div className="bg-fuchsia-50 p-6 rounded-2xl mb-6 text-center min-h-[120px] flex items-center justify-center">
                                                {challengeB ? <p className="text-fuchsia-900 font-bold text-lg">"{challengeB}"</p> : <p className="text-fuchsia-300">Es tu turno</p>}
                                            </div>
                                            <button onClick={()=>generateChallenge(false)} className="w-full py-3 rounded-xl border-2 border-fuchsia-100 text-fuchsia-600 font-bold mb-4 hover:bg-fuchsia-50 transition-colors">GENERAR RETO</button>
                                            
                                            {challengeB && (
                                                <label className="block w-full py-4 bg-fuchsia-600 text-white rounded-xl font-bold text-center cursor-pointer hover:bg-fuchsia-700 transition-colors shadow-lg shadow-fuchsia-200">
                                                    <Camera className="inline mr-2" size={20}/> CAPTURAR
                                                    <input type="file" className="hidden" accept="image/*" capture="environment" onChange={(e)=>handleFile(e, false)}/>
                                                </label>
                                            )}
                                        </>
                                    ) : photoB ? (
                                        <div className="relative rounded-2xl overflow-hidden">
                                            <img src={photoB} className="w-full h-48 object-cover"/>
                                            <div className="absolute bottom-0 w-full bg-black/60 p-2 text-white text-xs text-center backdrop-blur-sm">
                                                {challengeB}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-slate-300">Esperando al Jugador 1...</div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {photoA && photoB && (
                            <div className="p-6 border-t border-slate-50 bg-white">
                                <button onClick={handleFinalUpload} disabled={uploading} className="w-full bg-gradient-to-r from-indigo-600 to-fuchsia-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl hover:scale-[1.01] transition-transform flex justify-center gap-2">
                                    {uploading ? <Loader2 className="animate-spin"/> : 'COMPARTIR DÃšO'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const UploadModal = ({ isOpen, onClose, userId, userName, addToast, replyingTo }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [description, setDescription] = useState('');
            const [uploading, setUploading] = useState(false);
            const [activeFilter, setActiveFilter] = useState('normal');
            const [activeMood, setActiveMood] = useState(null);

            useEffect(() => { if (!isOpen) { setFile(null); setPreview(null); setDescription(''); setUploading(false); setActiveFilter('normal'); setActiveMood(null); } }, [isOpen]);

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (f) {
                    if (f.size > 8 * 1024 * 1024) { addToast("Imagen muy pesada", "error"); return; }
                    setFile(f);
                    const r = new FileReader(); r.onloadend = () => setPreview(r.result); r.readAsDataURL(f);
                }
            };

            const handleUpload = async () => {
                if (!file) return;
                setUploading(true);
                try {
                    const b64 = await processImage(file, activeFilter);
                    const payload = {
                        imageUrl: b64, description: description.trim(), photographerName: userName, photographerId: userId,
                        likes: [], createdAt: serverTimestamp(), mood: activeMood
                    };
                    if (replyingTo) payload.parentId = replyingTo.id;
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), payload);
                    addToast("Â¡Foto compartida!", "success"); onClose();
                } catch (error) { console.error(error); addToast("Error al subir", "error"); } 
                finally { setUploading(false); }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-[2rem] w-full max-w-md h-[90vh] flex flex-col overflow-hidden shadow-2xl border border-white/50">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-bold text-lg text-slate-800">{replyingTo ? 'Responder' : 'Nueva Captura'}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={20}/></button>
                        </div>
                        <div className="flex-1 p-6 overflow-y-auto space-y-6">
                            {replyingTo && <div className="bg-slate-50 p-3 rounded-xl flex gap-3 items-center border border-slate-200"><div className="w-12 h-12 rounded-lg bg-slate-200 overflow-hidden flex-shrink-0"><img src={replyingTo.imageUrl} className="w-full h-full object-cover"/></div><div className="overflow-hidden"><p className="text-xs text-slate-500 font-bold uppercase">Respondiendo a {replyingTo.photographerName}</p></div></div>}
                            {!preview ? (
                                <label className="h-56 border-2 border-dashed border-slate-300 hover:border-fuchsia-400 rounded-3xl flex items-center justify-center text-slate-400 flex-col cursor-pointer transition-all bg-slate-50 hover:bg-fuchsia-50/20 group">
                                    <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center shadow-sm mb-4 group-hover:scale-110"><Camera size={32} className="text-fuchsia-500"/></div>
                                    <span className="font-medium">Toca para elegir</span>
                                    <input type="file" className="hidden" accept="image/*" onChange={handleFileChange} />
                                </label>
                            ) : (
                                <div className="space-y-4">
                                    <div className="relative group rounded-2xl overflow-hidden shadow-lg border border-slate-100">
                                        <img src={preview} className="w-full h-auto object-contain" style={{ filter: FILTERS[activeFilter].filter }} />
                                        <button onClick={()=>{setPreview(null); setFile(null); setActiveFilter('normal');}} className="absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full"><X size={16}/></button>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">Filtros</label><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{Object.entries(FILTERS).map(([key, { name }]) => (<button key={key} onClick={() => setActiveFilter(key)} className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all border ${activeFilter === key ? 'bg-slate-800 text-white' : 'bg-white text-slate-500 border-slate-200'}`}>{name}</button>))}</div></div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 block">EmociÃ³n</label><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{MOODS.map((m) => (<button key={m.label} onClick={() => setActiveMood(m)} className={`flex-shrink-0 px-3 py-2 rounded-xl text-xs font-bold transition-all border flex items-center gap-1 ${activeMood?.label === m.label ? m.color + ' ring-2 ring-offset-1 ring-slate-200' : 'bg-white text-slate-500 border-slate-200'}`}><span>{m.emoji}</span> {m.label}</button>))}</div></div>
                                </div>
                            )}
                            <textarea value={description} onChange={(e) => setDescription(e.target.value)} placeholder="Â¿QuÃ© te hizo detenerte a mirar esta foto?" className="w-full p-5 bg-slate-50 rounded-2xl h-28 focus:ring-2 focus:ring-fuchsia-500 focus:outline-none transition-all placeholder:text-slate-400 resize-none text-slate-700"/>
                        </div>
                        <div className="p-6 border-t border-slate-50 bg-white">
                            <button onClick={handleUpload} disabled={!file || uploading} className="w-full bg-gradient-to-r from-rose-600 to-fuchsia-600 hover:from-rose-700 hover:to-fuchsia-700 text-white py-4 rounded-2xl font-bold flex justify-center gap-2 shadow-lg transition-all active:scale-[0.98]">
                                {uploading ? <Loader2 className="animate-spin"/> : <>Compartir <Send size={18}/></>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PhotoCard = React.memo(({ photo, onClick, user, toggleReaction, onReply }) => {
          // Si es un DÃšO, renderizado especial dividido
          if (photo.type === 'duo') {
              return (
                <div onClick={() => onClick(photo)} className="break-inside-avoid bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer mb-5 border border-indigo-100 group hover:-translate-y-1 relative ring-2 ring-indigo-50">
                    <div className="flex h-48">
                        <div className="w-1/2 relative border-r border-white">
                            <img src={photo.imgA} className="w-full h-full object-cover"/>
                            <div className="absolute bottom-0 w-full bg-black/60 p-1 text-[8px] text-white text-center backdrop-blur-sm truncate">{photo.challengeA}</div>
                        </div>
                        <div className="w-1/2 relative">
                            <img src={photo.imgB} className="w-full h-full object-cover"/>
                            <div className="absolute bottom-0 w-full bg-black/60 p-1 text-[8px] text-white text-center backdrop-blur-sm truncate">{photo.challengeB}</div>
                        </div>
                    </div>
                    <div className="p-3 bg-gradient-to-r from-indigo-50 to-fuchsia-50">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-[10px] text-indigo-600 font-extrabold uppercase tracking-widest bg-white px-2 py-1 rounded-md shadow-sm">RETO DÃšO</span>
                            <span className="text-[10px] text-slate-400 font-bold">{photo.photographerName}</span>
                        </div>
                        {/* REACCIONES EN DÃšOS (NUEVO) */}
                        <div className="flex items-center gap-1.5 overflow-x-auto scrollbar-hide py-1 pb-1" onClick={e => e.stopPropagation()}>
                            {REACTION_MAP.map((r) => {
                                const isSelected = photo[r.field]?.includes(user.uid);
                                const count = photo[r.field]?.length || 0;
                                return <button key={r.icon} onClick={() => toggleReaction(photo, r)} className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-full text-xs transition-all border font-medium ${isSelected ? r.color : 'text-slate-400 border-slate-100 bg-white hover:bg-slate-50'}`}><span className="text-sm transform transition-transform active:scale-125">{r.icon}</span> {count > 0 && <span>{count}</span>}</button>;
                            })}
                        </div>
                    </div>
                </div>
              );
          }

          // Renderizado normal
          return (
            <div onClick={() => onClick(photo)} className="break-inside-avoid bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer mb-5 border border-slate-100 group hover:-translate-y-1 relative">
              <div className="relative aspect-auto bg-slate-100 overflow-hidden">
                <img src={photo.imageUrl} className="w-full h-auto block transition-transform duration-700 group-hover:scale-105" loading="lazy" />
                {photo.mood && <div className={`absolute top-3 left-3 px-2.5 py-1 rounded-lg text-[10px] font-bold shadow-sm backdrop-blur-md ${photo.mood.color}`}>{photo.mood.emoji} {photo.mood.label}</div>}
                {photo.parentId && <div className="absolute top-3 right-3 bg-black/50 text-white px-2 py-1 rounded-md text-[10px] backdrop-blur-md flex items-center gap-1"><Reply size={10} /> Respuesta</div>}
              </div>
              <div className="p-4">
                <p className="text-slate-700 text-sm mb-3 font-medium leading-relaxed">"{photo.description}"</p>
                <div className="flex justify-between items-center mb-4">
                   <span className="text-[10px] text-fuchsia-600 font-extrabold uppercase tracking-widest bg-fuchsia-50 px-2 py-1 rounded-md">{photo.photographerName}</span>
                   <button onClick={(e) => { e.stopPropagation(); onReply(photo); }} className="text-slate-400 hover:text-fuchsia-600 p-1.5 hover:bg-fuchsia-50 rounded-full transition-colors"><Reply size={16} /></button>
                </div>
                <div className="flex items-center gap-1.5 overflow-x-auto scrollbar-hide py-1 pb-1" onClick={e => e.stopPropagation()}>
                    {REACTION_MAP.map((r) => {
                        const isSelected = photo[r.field]?.includes(user.uid);
                        const count = photo[r.field]?.length || 0;
                        return (
                            <button key={r.icon} onClick={() => toggleReaction(photo, r)} className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-full text-xs transition-all border font-medium ${isSelected ? r.color : 'text-slate-400 border-slate-100 bg-slate-50 hover:bg-white'}`}>
                                <span className="text-sm transform transition-transform active:scale-125">{r.icon}</span> {count > 0 && <span>{count}</span>}
                            </button>
                        );
                    })}
                </div>
              </div>
            </div>
          );
        }, (prev, next) => prev.photo.id === next.photo.id && REACTION_MAP.every(r => (prev.photo[r.field]?.length || 0) === (next.photo[r.field]?.length || 0) && prev.photo[r.field]?.includes(prev.user.uid) === next.photo[r.field]?.includes(next.user.uid)));

        const ImageViewerModal = ({ photo, user, onClose, onDelete, toggleReaction }) => {
            if (!photo) return null;
            
            // Renderizado especial para DÃšOS en pantalla completa
            if (photo.type === 'duo') {
                return (
                    <div className="fixed inset-0 z-[90] bg-slate-950/95 backdrop-blur-xl flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                        <button onClick={onClose} className="absolute top-6 right-6 text-white/50 hover:text-white p-2 z-50"><X size={24}/></button>
                        {user.uid === photo.photographerId && <button onClick={(e)=>{e.stopPropagation(); onDelete(photo.id)}} className="absolute top-6 left-6 text-white/50 hover:text-red-400 p-2 z-50"><Trash2 size={24}/></button>}
                        
                        <div className="w-full max-w-6xl h-full flex flex-col items-center justify-center" onClick={e => e.stopPropagation()}>
                            <div className="flex flex-col md:flex-row gap-4 w-full h-[60vh] md:h-[70vh]">
                                <div className="flex-1 relative bg-black rounded-2xl overflow-hidden shadow-2xl group">
                                    <img src={photo.imgA} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity"/>
                                    <div className="absolute bottom-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-20">
                                        <p className="text-white text-lg font-bold text-center">"{photo.challengeA}"</p>
                                        <p className="text-slate-400 text-xs text-center mt-1 uppercase tracking-widest">Jugador 1</p>
                                    </div>
                                </div>
                                <div className="flex-1 relative bg-black rounded-2xl overflow-hidden shadow-2xl group">
                                    <img src={photo.imgB} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity"/>
                                    <div className="absolute bottom-0 w-full bg-gradient-to-t from-black/80 to-transparent p-6 pt-20">
                                        <p className="text-white text-lg font-bold text-center">"{photo.challengeB}"</p>
                                        <p className="text-slate-400 text-xs text-center mt-1 uppercase tracking-widest">Jugador 2</p>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-8 text-center">
                                <div className="flex items-center justify-center gap-4 bg-white/10 px-8 py-3 rounded-full backdrop-blur-md border border-white/10 shadow-lg mb-4">
                                    {REACTION_MAP.map((r) => {
                                        const isSelected = photo[r.field]?.includes(user.uid);
                                        const count = photo[r.field]?.length || 0;
                                        return <button key={r.icon} onClick={() => toggleReaction(photo, r)} className={`flex flex-col items-center gap-1 ${isSelected ? 'opacity-100 scale-110' : 'opacity-40 hover:opacity-100'}`}><span className="text-3xl">{r.icon}</span>{count > 0 && <span className="text-[10px] font-bold text-white">{count}</span>}</button>;
                                    })}
                                </div>
                                <span className="bg-indigo-500/20 text-indigo-200 border border-indigo-500/50 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest inline-block">Reto Completado por {photo.photographerName}</span>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-[90] bg-slate-950/95 backdrop-blur-xl flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-6 right-6 text-white/50 hover:text-white p-2 z-50"><X size={24}/></button>
                    {user.uid === photo.photographerId && <button onClick={(e)=>{e.stopPropagation(); onDelete(photo.id)}} className="absolute top-6 left-6 text-white/50 hover:text-red-400 p-2 z-50"><Trash2 size={24}/></button>}
                    <div className="relative w-full max-w-5xl max-h-screen flex flex-col items-center justify-center h-full py-8" onClick={e => e.stopPropagation()}>
                        <div className="relative shadow-2xl rounded-lg overflow-hidden bg-black max-h-[75vh]"><img src={photo.imageUrl} className="max-w-full max-h-[75vh] object-contain" /></div>
                        <div className="w-full mt-8 text-white text-center max-w-2xl mx-auto">
                            {photo.mood && <span className={`inline-block mb-4 px-3 py-1 rounded-full text-xs font-bold ${photo.mood.color}`}>{photo.mood.emoji} {photo.mood.label}</span>}
                            <p className="text-xl font-medium text-slate-200 mb-6">"{photo.description}"</p>
                            <div className="flex items-center justify-center gap-4 bg-white/10 px-8 py-3 rounded-full backdrop-blur-md border border-white/10 shadow-lg">
                                {REACTION_MAP.map((r) => {
                                    const isSelected = photo[r.field]?.includes(user.uid);
                                    const count = photo[r.field]?.length || 0;
                                    return <button key={r.icon} onClick={() => toggleReaction(photo, r)} className={`flex flex-col items-center gap-1 ${isSelected ? 'opacity-100 scale-110' : 'opacity-40 hover:opacity-100'}`}><span className="text-3xl">{r.icon}</span>{count > 0 && <span className="text-[10px] font-bold text-white">{count}</span>}</button>;
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [hasEntered, setHasEntered] = useState(false);
            const [toasts, setToasts] = useState([]);
            const [photos, setPhotos] = useState([]);
            const [config, setConfig] = useState({ title: 'Mirada TerapÃ©utica', subtitle: 'Bienvenido' });
            const [showUpload, setShowUpload] = useState(false);
            const [showDuoUpload, setShowDuoUpload] = useState(false);
            const [showConfig, setShowConfig] = useState(false);
            const [showRules, setShowRules] = useState(false);
            const [showQR, setShowQR] = useState(false); 
            const [showInspiration, setShowInspiration] = useState(false);
            const [viewerPhotoId, setViewerPhotoId] = useState(null);
            const [replyingTo, setReplyingTo] = useState(null);
            
            const addToast = (msg, type='info') => { const id = Date.now(); setToasts(p => [...p, {id, message: msg, type}]); setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000); };

            useEffect(() => {
                const initAuth = async () => {
                    if (initialAuthToken) try { await signInWithCustomToken(auth, initialAuthToken); } catch (e) { await signInAnonymously(auth); }
                    else await signInAnonymously(auth);
                };
                initAuth();
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubPhotos = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), orderBy('createdAt', 'desc')), s => setPhotos(s.docs.map(d => ({id: d.id, ...d.data()}))), err => console.error(err));
                const unsubConfig = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), s => { if(s.exists()) setConfig(prev => ({...prev, ...s.data()})); });
                return () => { unsubPhotos(); unsubConfig(); };
            }, [user]);

            const toggleReaction = async (photo, reactionType) => {
                if(!user) return;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'workshop_photos', photo.id);
                const fieldName = reactionType.field;
                const liked = photo[fieldName]?.includes(user.uid);
                const updateData = {}; updateData[fieldName] = liked ? arrayRemove(user.uid) : arrayUnion(user.uid);
                await updateDoc(ref, updateData);
            };

            const deletePhoto = async (id) => { if(confirm("Â¿Eliminar?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'workshop_photos', id)); setViewerPhotoId(null); addToast("Eliminado", "success"); } };

            const handleReply = (photo) => { setReplyingTo(photo); setShowUpload(true); };
            const currentPhoto = photos.find(p => p.id === viewerPhotoId);

            if (!user) return <div className="h-screen flex items-center justify-center bg-slate-50 text-fuchsia-500"><Loader2 className="animate-spin" size={40}/></div>;

            return (
                <div className="min-h-screen relative font-sans text-slate-800">
                    <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
                        <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] rounded-full bg-rose-200/30 blur-3xl opacity-50 mix-blend-multiply animate-pulse"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] rounded-full bg-fuchsia-200/30 blur-3xl opacity-50 mix-blend-multiply"></div>
                        <div className="absolute top-[40%] left-[30%] w-[40%] h-[40%] rounded-full bg-slate-200/40 blur-3xl opacity-40 mix-blend-multiply"></div>
                        <div className="absolute inset-0 transition-all duration-700" style={{ backgroundImage: config.backgroundUrl ? `url(${config.backgroundUrl})` : 'none', backgroundPosition: 'center', backgroundRepeat: 'no-repeat', backgroundSize: '50%', opacity: 0.08, filter: 'grayscale(100%)' }} />
                    </div>
                    <ToastContainer toasts={toasts} />
                    {!hasEntered ? (
                        <LoginScreen onLogin={() => setHasEntered(true)} addToast={addToast} config={config} currentUser={user} onShowRules={() => setShowRules(true)} />
                    ) : (
                        <>
                            <header className="fixed top-0 inset-x-0 bg-white/70 backdrop-blur-xl border-b border-slate-200/50 z-40 px-4 py-3 flex justify-between items-center shadow-sm transition-all">
                                <div className="flex items-center gap-3 flex-1 min-w-0 mr-4">
                                    <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-rose-600 to-fuchsia-600 flex items-center justify-center text-white flex-shrink-0 shadow-lg shadow-rose-500/20"><Camera size={18}/></div>
                                    <h1 className="font-bold text-slate-800 truncate text-lg tracking-tight">{config.title}</h1>
                                </div>
                                <div className="flex gap-2 flex-shrink-0">
                                    <button onClick={()=>setShowInspiration(true)} className="p-2.5 hover:bg-slate-100 rounded-xl text-amber-500 hover:text-amber-700 transition-colors" title="InspiraciÃ³n"><Lightbulb size={20}/></button>
                                    <div className="w-px h-6 bg-slate-200 my-auto mx-1"></div>
                                    <button onClick={()=>setShowQR(true)} className="p-2.5 hover:bg-slate-100 rounded-xl text-slate-600 hover:text-slate-900 transition-colors"><QrCode size={20}/></button>
                                    <button onClick={()=>setShowConfig(true)} className="p-2.5 hover:bg-slate-100 rounded-xl text-slate-600 hover:text-slate-900 transition-colors"><Settings size={20}/></button>
                                </div>
                            </header>
                            <main className="pt-24 pb-32 px-4 max-w-7xl mx-auto">
                                {photos.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center py-32 text-slate-300">
                                        <div className="bg-slate-100 p-6 rounded-full mb-4"><ImageIcon size={48} className="text-slate-300"/></div>
                                        <p className="text-lg font-medium text-slate-400">AÃºn no hay momentos capturados.</p>
                                    </div>
                                ) : (
                                    <div className="columns-2 md:columns-3 lg:columns-4 gap-5 space-y-5">
                                        {photos.map(p => ( 
                                            <PhotoCard key={p.id} photo={p} user={user} onClick={() => setViewerPhotoId(p.id)} toggleReaction={toggleReaction} onReply={handleReply} /> 
                                        ))}
                                    </div>
                                )}
                            </main>
                            <Stopwatch />
                            
                            {/* FAB GROUP */}
                            <div className="fixed bottom-8 right-8 z-40 flex flex-col gap-4 items-end">
                                <button onClick={()=>setShowDuoUpload(true)} className="bg-white hover:bg-indigo-50 text-indigo-600 p-4 rounded-2xl shadow-xl shadow-indigo-900/10 flex items-center gap-3 hover:scale-105 transition-all duration-300 border border-indigo-100 group">
                                    <span className="font-bold text-xs tracking-wide mr-1">Modo DÃºo</span> <Users size={22} className="group-hover:rotate-12 transition-transform"/>
                                </button>
                                <button onClick={() => { setReplyingTo(null); setShowUpload(true); }} className="bg-slate-900 hover:bg-black text-white p-5 rounded-2xl shadow-2xl shadow-slate-900/30 flex items-center gap-3 hover:scale-105 transition-all duration-300 border border-slate-700/50 group">
                                    <Camera size={24} className="group-hover:rotate-12 transition-transform"/> <span className="font-bold text-sm tracking-wide">Capturar</span>
                                </button>
                            </div>
                            
                            <UploadModal isOpen={showUpload} onClose={() => { setShowUpload(false); setReplyingTo(null); }} userId={user.uid} userName={user.displayName} addToast={addToast} replyingTo={replyingTo} />
                            <DuoUploadModal isOpen={showDuoUpload} onClose={()=>setShowDuoUpload(false)} userId={user.uid} userName={user.displayName} addToast={addToast} />
                            
                            {currentPhoto && (
                                <ImageViewerModal photo={currentPhoto} user={user} onClose={() => setViewerPhotoId(null)} onDelete={deletePhoto} toggleReaction={toggleReaction} />
                            )}
                            {showQR && ( <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowQR(false)}> <div className="bg-white p-8 rounded-[2rem] max-w-sm w-full text-center shadow-2xl border border-white/20" onClick={e => e.stopPropagation()}> <h3 className="font-bold text-2xl mb-6 text-slate-800">Escanea para entrar</h3> <div className="bg-white p-4 border-2 border-dashed border-slate-200 rounded-3xl inline-block mb-8 shadow-sm"> <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(window.location.href)}`} alt="QR" className="w-56 h-56 mix-blend-multiply" /> </div> <button onClick={() => setShowQR(false)} className="w-full py-3.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold text-sm flex items-center justify-center gap-2 transition-colors">Cerrar</button> </div> </div> )}
                            <ConfigModal isOpen={showConfig} onClose={()=>setShowConfig(false)} addToast={addToast} currentConfig={config} />
                            <RulesModal isOpen={showRules} onClose={() => setShowRules(false)} />
                            <InspirationModal isOpen={showInspiration} onClose={() => setShowInspiration(false)} />
                        </>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
