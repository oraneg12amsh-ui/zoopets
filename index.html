<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirada Terap√©utica</title>
    
    <!-- 1. Tailwind CSS (Dise√±o) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Motor de la App) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <!-- 3. Babel (Para entender el c√≥digo moderno en el navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Animaciones personalizadas */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Ocultar scrollbar en la lista de reacciones horizontal */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-rose-50 text-stone-800">
    <div id="root"></div>

    <!-- C√ìDIGO DE LA APLICACI√ìN -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signOut, signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, setDoc, 
            arrayUnion, arrayRemove, onSnapshot, serverTimestamp, query, orderBy, 
            enableIndexedDbPersistence 
        } from 'firebase/firestore';
        import { 
            Camera, Send, X, QrCode, Heart, Image as ImageIcon, Loader2, WifiOff, 
            Copy, Check, Trash2, LogOut, AlertCircle, Info, Settings, Type, Sparkles, Lock, Share2, BookOpen,
            ChevronLeft, ChevronRight, Timer, Play, Pause, RotateCcw, Minimize2
        } from 'lucide-react';

        // ==========================================
        //  CONFIGURACI√ìN H√çBRIDA (INTELIGENTE)
        // ==========================================
        let firebaseConfig, appId, initialAuthToken;

        if (typeof __firebase_config !== 'undefined') {
            console.log("Modo: Entorno de Chat detectado (Configuraci√≥n autom√°tica)");
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        } 
        else {
            console.log("Modo: Exportaci√≥n (Configuraci√≥n manual activada)");
            // ‚úÖ CONFIGURACI√ìN REAL DE "PLATAFORMA CARMEN SERD√ÅN"
            firebaseConfig = {
                apiKey: "AIzaSyDT9M_s82TJrxwFMMFFt_M7GrQdVUFXZ2c",
                authDomain: "plataforma-carmen-serdan.firebaseapp.com",
                projectId: "plataforma-carmen-serdan",
                storageBucket: "plataforma-carmen-serdan.firebasestorage.app",
                messagingSenderId: "124079826705",
                appId: "1:124079826705:web:5e2abd11506ae24accceb0",
                measurementId: "G-VCYFS0K3BB"
            };
            appId = 'mirada-terapeutica-web'; 
            initialAuthToken = null;
        }

        // Inicializar Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            enableIndexedDbPersistence(db).catch(() => {}); 
        } catch (e) {
            console.error("Error inicializando Firebase.", e);
        }

        // --- MAPA DE REACCIONES ---
        const REACTION_MAP = [
            { icon: '‚ù§', field: 'likes', color: 'text-red-500 bg-red-100 border-red-200' },
            { icon: 'ü§£', field: 'likes_funny', color: 'text-yellow-500 bg-yellow-100 border-yellow-200' },
            { icon: 'üòç', field: 'likes_love', color: 'text-rose-500 bg-rose-100 border-rose-200' },
            { icon: 'üò±', field: 'likes_shock', color: 'text-blue-500 bg-blue-100 border-blue-200' },
            { icon: 'ü§°', field: 'likes_clown', color: 'text-purple-500 bg-purple-100 border-purple-200' },
            { icon: 'ü§≠', field: 'likes_giggle', color: 'text-orange-500 bg-orange-100 border-orange-200' }
        ];

        // --- COMPONENTES ---

        const ToastContainer = ({ toasts }) => (
            <div className="fixed top-20 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                {toasts.map(toast => (
                    <div key={toast.id} className={`pointer-events-auto flex items-center gap-2 px-4 py-3 rounded-lg shadow-lg text-sm font-medium animate-fade-in ${
                        toast.type === 'error' ? 'bg-red-600 text-white' : 
                        toast.type === 'success' ? 'bg-rose-600 text-white' : 'bg-red-900 text-white'
                    }`}>
                        {toast.type === 'error' ? <AlertCircle size={16}/> : <Check size={16}/>}
                        {toast.message}
                    </div>
                ))}
            </div>
        );

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 800;
                        let { width, height } = img;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                        else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.65));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const Stopwatch = () => {
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);

            useEffect(() => {
                let interval;
                if (isRunning) {
                    interval = setInterval(() => setTime(t => t + 1), 1000);
                }
                return () => clearInterval(interval);
            }, [isRunning]);

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            };

            if (!isExpanded) {
                return (
                    <button
                        onClick={() => setIsExpanded(true)}
                        className="fixed bottom-6 left-6 z-40 bg-white text-red-800 p-4 rounded-full shadow-xl flex items-center gap-2 hover:scale-105 transition-transform border-4 border-white/50 shadow-red-900/20"
                    >
                        <Timer size={24} />
                        {time > 0 && <span className="font-bold font-mono text-sm">{formatTime(time)}</span>}
                    </button>
                );
            }

            return (
                <div className="fixed inset-0 z-[120] bg-red-950/95 backdrop-blur-md flex items-center justify-center p-6 animate-fade-in">
                    <div className="flex flex-col items-center w-full max-w-lg text-center">
                        <div className="text-red-200 font-serif text-2xl mb-8">Cron√≥metro</div>
                        
                        <div className="text-white font-mono text-9xl font-bold mb-12 drop-shadow-2xl tabular-nums tracking-widest">
                            {formatTime(time)}
                        </div>

                        <div className="flex gap-8 mb-16">
                            <button
                                onClick={() => setIsRunning(!isRunning)}
                                className="bg-white text-red-900 p-8 rounded-full shadow-2xl hover:scale-110 active:scale-95 transition-transform"
                            >
                                {isRunning ? <Pause size={48} fill="currentColor" /> : <Play size={48} fill="currentColor" className="ml-2" />}
                            </button>
                            <button
                                onClick={() => { setIsRunning(false); setTime(0); }}
                                className="bg-red-800 text-white p-8 rounded-full border-2 border-red-400 hover:bg-red-700 active:scale-95 transition-all"
                            >
                                <RotateCcw size={48} />
                            </button>
                        </div>

                        <button
                            onClick={() => setIsExpanded(false)}
                            className="text-white/60 hover:text-white flex items-center gap-2 py-3 px-6 rounded-full hover:bg-white/10 transition-colors"
                        >
                            <Minimize2 size={20} /> Minimizar vista
                        </button>
                    </div>
                </div>
            );
        };

        // --- PANTALLAS ---

        const RulesModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-3xl max-w-md w-full shadow-2xl overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-6 bg-red-900 text-white flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <BookOpen size={24} />
                                <h3 className="font-serif text-xl font-bold">Reglas del Taller</h3>
                            </div>
                            <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full transition-colors"><X size={24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6 text-stone-700 leading-relaxed">
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">1.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Espacio Seguro</h4>
                                    <p className="text-sm">Este es un lugar libre de juicios. Comentamos desde el respeto y la empat√≠a.</p>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">2.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Autenticidad</h4>
                                    <p className="text-sm">Comparte fotos que signifiquen algo para ti. No buscamos perfecci√≥n t√©cnica, sino honestidad emocional.</p>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">3.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Confidencialidad</h4>
                                    <p className="text-sm">Lo que se comparte en el taller, se queda en el taller. Respetamos la privacidad de las historias de los compa√±eros.</p>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <div className="text-red-500 font-bold text-xl">4.</div>
                                <div>
                                    <h4 className="font-bold text-red-900 mb-1">Escucha Activa</h4>
                                    <p className="text-sm">Prestamos atenci√≥n a lo que dicen las im√°genes y las palabras de los dem√°s.</p>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t border-red-50 bg-red-50/50 text-center">
                            <button onClick={onClose} className="bg-red-800 text-white px-8 py-3 rounded-xl font-medium shadow-lg hover:bg-red-900 transition-colors w-full">
                                Entendido
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, addToast, config, currentUser, onShowRules }) => {
            const [name, setName] = useState(currentUser?.displayName || '');
            const [loading, setLoading] = useState(false);
            const [showLoginQR, setShowLoginQR] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                setLoading(true);
                try {
                    if (auth.currentUser) {
                        await updateProfile(auth.currentUser, { displayName: name });
                        onLogin();
                    } else {
                        if (initialAuthToken) {
                            try { await signInWithCustomToken(auth, initialAuthToken); } catch (err) { await signInAnonymously(auth); }
                        } else {
                            await signInAnonymously(auth);
                        }
                        if (auth.currentUser) {
                             await updateProfile(auth.currentUser, { displayName: name });
                             onLogin();
                        }
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    addToast("Error de conexi√≥n.", "error");
                } finally { setLoading(false); }
            };

            const handleShare = () => {
                const url = window.location.href;
                if (navigator.share) {
                    navigator.share({ title: config.title, url }).catch(()=>{});
                } else {
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = url;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        textArea.style.top = "0";
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        if (successful) addToast("Enlace copiado", "success");
                        else throw new Error("Copy failed");
                    } catch (err) {
                        addToast("Copia el enlace manualmente", "error");
                    }
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative z-10">
                    <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl p-8 w-full max-w-md text-center border border-white/50 animate-fade-in">
                        <div className="w-32 h-32 mx-auto mb-6 flex items-center justify-center">
                            {config.backgroundUrl ? (
                                <img src={config.backgroundUrl} className="w-full h-full object-contain drop-shadow-md" alt="Logo"/>
                            ) : (
                                <div className="w-20 h-20 rounded-2xl bg-gradient-to-tr from-red-600 to-rose-500 flex items-center justify-center text-white shadow-lg">
                                    <Camera size={40} />
                                </div>
                            )}
                        </div>
                        <h1 className="text-3xl font-serif text-red-950 mb-2">{config.title || 'Mirada Terap√©utica'}</h1>
                        <p className="text-red-800/80 mb-8 text-sm font-medium">{config.subtitle || 'Espacio seguro.'}</p>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" placeholder="¬øC√≥mo te llamas?" value={name} onChange={e => setName(e.target.value)}
                                className="w-full px-4 py-4 rounded-xl border-2 border-red-50 bg-white/50 focus:outline-none focus:border-rose-400 text-center text-lg" required />
                            <button type="submit" disabled={loading} className="w-full bg-red-800 hover:bg-red-900 text-white font-medium py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                {loading ? <Loader2 className="animate-spin"/> : 'Ingresar al Taller'}
                            </button>
                        </form>
                        
                        <div className="flex flex-wrap justify-center gap-3 mt-6">
                            <button onClick={onShowRules} className="text-xs text-red-700 bg-red-100 hover:bg-red-200 flex items-center justify-center gap-2 py-2 px-4 rounded-full transition-colors font-medium w-full mb-2">
                                <BookOpen size={16} /> Reglas del Taller
                            </button>
                            <button onClick={handleShare} className="text-xs text-red-400 hover:text-red-600 flex items-center justify-center gap-2 py-2 px-4 rounded-full hover:bg-red-50 transition-colors">
                                <Share2 size={16} /> Compartir Enlace
                            </button>
                            <button onClick={() => setShowLoginQR(true)} className="text-xs text-red-400 hover:text-red-600 flex items-center justify-center gap-2 py-2 px-4 rounded-full hover:bg-red-50 transition-colors">
                                <QrCode size={16} /> Mostrar QR
                            </button>
                        </div>
                    </div>

                    {showLoginQR && (
                        <div className="fixed inset-0 z-[100] bg-red-950/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowLoginQR(false)}>
                            <div className="bg-white p-6 rounded-3xl max-w-sm w-full text-center shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="font-serif text-xl mb-4 text-red-900">Escanea para entrar</h3>
                                <div className="bg-white p-2 border border-red-100 rounded-xl inline-block mb-4 shadow-inner">
                                    <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(window.location.href)}`} alt="QR" className="w-48 h-48 mix-blend-multiply" />
                                </div>
                                <button onClick={() => setShowLoginQR(false)} className="w-full py-3 rounded-xl bg-red-50 hover:bg-red-100 text-red-900 font-bold text-sm flex items-center justify-center gap-2">
                                    Cerrar
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, addToast, currentConfig }) => {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [title, setTitle] = useState('');
            const [subtitle, setSubtitle] = useState('');
            const [loading, setLoading] = useState(false);
            const [authAdmin, setAuthAdmin] = useState(false);
            const [u, setU] = useState(''); const [p, setP] = useState('');

            useEffect(() => {
                if (isOpen) {
                    setPreview(currentConfig.backgroundUrl); setTitle(currentConfig.title); setSubtitle(currentConfig.subtitle);
                    setAuthAdmin(false); setU(''); setP('');
                }
            }, [isOpen]);

            const handleSave = async () => {
                if (!auth.currentUser) return;
                setLoading(true);
                try {
                    let url = currentConfig.backgroundUrl;
                    if (file) url = await compressImage(file);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), {
                        backgroundUrl: url, title, subtitle, updatedAt: serverTimestamp()
                    }, { merge: true });
                    addToast("Guardado", "success"); onClose();
                } catch(e) { console.error(e); addToast("Error guardando", "error"); } finally { setLoading(false); }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (u === 'ADMIN' && p === 'ADMIN123') { setAuthAdmin(true); addToast("Acceso correcto", "success"); }
                else addToast("Credenciales incorrectas", "error");
            }

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="flex justify-between p-6 border-b border-red-50">
                            <h3 className="text-xl font-serif text-red-900">{authAdmin ? 'Personalizar' : 'Admin'}</h3>
                            <button onClick={onClose}><X className="text-red-300"/></button>
                        </div>
                        {!authAdmin ? (
                            <form onSubmit={handleLogin} className="p-8 flex flex-col gap-4 text-center">
                                <Lock className="w-12 h-12 text-red-500 mx-auto mb-2"/>
                                <p className="text-sm text-red-400">√Årea restringida</p>
                                <input type="text" placeholder="Usuario" value={u} onChange={e=>setU(e.target.value)} className="p-3 rounded-xl border border-red-100 text-center"/>
                                <input type="password" placeholder="Contrase√±a" value={p} onChange={e=>setP(e.target.value)} className="p-3 rounded-xl border border-red-100 text-center"/>
                                <button className="bg-red-800 text-white py-3 rounded-xl">Entrar</button>
                            </form>
                        ) : (
                            <div className="p-6 space-y-6 overflow-y-auto">
                                <div className="space-y-3">
                                    <label className="text-xs text-red-400">T√≠tulo</label>
                                    <input value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-3 bg-red-50 rounded-xl border-red-100 border"/>
                                    <label className="text-xs text-red-400">Subt√≠tulo</label>
                                    <textarea value={subtitle} onChange={e=>setSubtitle(e.target.value)} className="w-full p-3 bg-red-50 rounded-xl border-red-100 border h-20"/>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs text-red-400">Logo / Fondo</label>
                                    <label className="block w-full h-32 border-2 border-dashed border-red-200 rounded-xl flex items-center justify-center cursor-pointer relative overflow-hidden">
                                        {preview ? <img src={preview} className="h-full object-contain"/> : <ImageIcon className="text-red-300"/>}
                                        <input type="file" className="hidden" onChange={e => {
                                            const f = e.target.files[0];
                                            if(f) { setFile(f); const r = new FileReader(); r.onload=()=>setPreview(r.result); r.readAsDataURL(f); }
                                        }}/>
                                    </label>
                                    {preview && <button onClick={async ()=>{
                                        if(confirm("¬øBorrar fondo?")) {
                                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), { backgroundUrl: null }, { merge: true });
                                            setPreview(null);
                                        }
                                    }} className="text-xs text-red-500 flex items-center gap-1"><Trash2 size={12}/> Quitar fondo</button>}
                                </div>
                                <button onClick={handleSave} disabled={loading} className="w-full bg-red-800 text-white py-3 rounded-xl flex justify-center gap-2">
                                    {loading ? <Loader2 className="animate-spin"/> : 'Guardar Cambios'}
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PhotoCard = React.memo(({ photo, onClick, user, toggleReaction }) => {
          return (
            <div 
              onClick={() => onClick(photo)}
              className="break-inside-avoid bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer mb-4 border border-red-50"
            >
              <div className="relative aspect-auto bg-stone-100">
                <img src={photo.imageUrl} alt="Momento" className="w-full h-auto block" loading="lazy" />
              </div>
              <div className="p-3">
                <p className="text-stone-700 text-sm mb-2 font-serif italic line-clamp-2 leading-relaxed">"{photo.description}"</p>
                <div className="flex justify-between items-center mb-3">
                   <span className="text-[10px] text-red-400 font-bold uppercase tracking-wider">{photo.photographerName}</span>
                </div>
                
                {/* BARRA DE REACCIONES MINIATURA */}
                <div className="flex items-center gap-1 overflow-x-auto scrollbar-hide py-1" onClick={e => e.stopPropagation()}>
                    {REACTION_MAP.map((r) => {
                        const isSelected = photo[r.field]?.includes(user.uid);
                        const count = photo[r.field]?.length || 0;
                        return (
                            <button 
                                key={r.icon}
                                onClick={() => toggleReaction(photo, r)}
                                className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs transition-all border ${
                                    isSelected ? r.color : 'text-stone-400 border-transparent hover:bg-stone-50 grayscale hover:grayscale-0'
                                }`}
                            >
                                <span className="text-sm">{r.icon}</span>
                                {count > 0 && <span className="font-bold">{count}</span>}
                            </button>
                        );
                    })}
                </div>
              </div>
            </div>
          );
        }, (prev, next) => {
            // Optimizaci√≥n de renderizado: solo actualizar si cambian likes o propiedades b√°sicas
            const idSame = prev.photo.id === next.photo.id;
            const reactionsSame = REACTION_MAP.every(r => 
                (prev.photo[r.field]?.length || 0) === (next.photo[r.field]?.length || 0) &&
                prev.photo[r.field]?.includes(prev.user.uid) === next.photo[r.field]?.includes(next.user.uid)
            );
            return idSame && reactionsSame;
        });

        const ImageViewerModal = ({ photo, user, onClose, onDelete, onNext, onPrev, hasNext, hasPrev, toggleReaction }) => {
            if (!photo) return null;
            
            // Swipe handlers
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const minSwipeDistance = 50;

            const onTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart(e.targetTouches[0].clientX);
            };
            const onTouchMove = (e) => setTouchEnd(e.targetTouches[0].clientX);
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                if (isLeftSwipe && hasNext) onNext();
                if (isRightSwipe && hasPrev) onPrev();
            };

            // Keyboard navigation
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowRight' && hasNext) onNext();
                    if (e.key === 'ArrowLeft' && hasPrev) onPrev();
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [hasNext, hasPrev, onNext, onPrev, onClose]);

            return (
                <div className="fixed inset-0 z-[90] bg-black flex items-center justify-center p-4" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/50 hover:text-white p-2 z-50 transition-colors"><X size={32}/></button>
                    {user.uid === photo.photographerId && (
                        <button onClick={(e)=>{e.stopPropagation(); onDelete(photo.id)}} className="absolute top-4 left-4 text-white/50 hover:text-red-400 p-2 z-50 transition-colors"><Trash2/></button>
                    )}
                    
                    {/* Bot√≥n Anterior */}
                    {hasPrev && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); onPrev(); }}
                            className="absolute left-2 md:left-8 text-white/70 hover:text-white p-3 rounded-full hover:bg-white/10 transition-all z-40"
                        >
                            <ChevronLeft size={40} />
                        </button>
                    )}

                    {/* Contenido Central */}
                    <div 
                        className="relative w-full max-w-4xl max-h-screen flex flex-col items-center" 
                        onClick={(e) => e.stopPropagation()}
                        onTouchStart={onTouchStart}
                        onTouchMove={onTouchMove}
                        onTouchEnd={onTouchEnd}
                    >
                        <img src={photo.imageUrl} alt="Detalle" className="max-w-full max-h-[70vh] object-contain rounded-sm shadow-2xl bg-stone-900 select-none" draggable="false" />
                        
                        <div className="w-full mt-6 text-white text-center">
                            <p className="text-xl font-serif italic text-stone-200 mb-4">"{photo.description || 'Sin descripci√≥n'}"</p>
                            <div className="flex flex-col items-center gap-4">
                                <span className="uppercase tracking-wider text-xs font-bold bg-white/10 px-4 py-1 rounded-full text-stone-300">{photo.photographerName}</span>
                                
                                {/* REACCIONES EN PANTALLA COMPLETA */}
                                <div className="flex items-center gap-3 bg-white/10 px-6 py-2 rounded-full backdrop-blur-md">
                                    {REACTION_MAP.map((r) => {
                                        const isSelected = photo[r.field]?.includes(user.uid);
                                        const count = photo[r.field]?.length || 0;
                                        return (
                                            <button 
                                                key={r.icon}
                                                onClick={() => toggleReaction(photo, r)}
                                                className={`flex flex-col items-center gap-0 transition-all transform active:scale-125 ${
                                                    isSelected ? 'opacity-100 scale-110' : 'opacity-50 hover:opacity-100'
                                                }`}
                                            >
                                                <span className="text-2xl">{r.icon}</span>
                                                {count > 0 && <span className="text-[10px] font-bold">{count}</span>}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Bot√≥n Siguiente */}
                    {hasNext && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); onNext(); }}
                            className="absolute right-2 md:right-8 text-white/70 hover:text-white p-3 rounded-full hover:bg-white/10 transition-all z-40"
                        >
                            <ChevronRight size={40} />
                        </button>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [hasEntered, setHasEntered] = useState(false);
            const [toasts, setToasts] = useState([]);
            const [photos, setPhotos] = useState([]);
            const [config, setConfig] = useState({ title: 'Mirada Terap√©utica', subtitle: 'Bienvenido' });
            const [showUpload, setShowUpload] = useState(false);
            const [showConfig, setShowConfig] = useState(false);
            const [showRules, setShowRules] = useState(false);
            const [showQR, setShowQR] = useState(false); // Estado para el QR del Header
            
            // Estado para el visor que ahora guarda el OBJETO foto completo, pero usaremos el √≠ndice para navegar
            const [viewerPhotoId, setViewerPhotoId] = useState(null);
            
            // Toast Helper
            const addToast = (msg, type='info') => {
                const id = Date.now(); setToasts(p => [...p, {id, message: msg, type}]);
                setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
            };

            useEffect(() => {
                const initAuth = async () => {
                    if (initialAuthToken) {
                        try { await signInWithCustomToken(auth, initialAuthToken); } catch (e) { await signInAnonymously(auth); }
                    } else { await signInAnonymously(auth); }
                };
                initAuth();
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubPhotos = onSnapshot(
                    query(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), orderBy('createdAt', 'desc')), 
                    s => setPhotos(s.docs.map(d => ({id: d.id, ...d.data()}))),
                    err => console.error(err)
                );
                const unsubConfig = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'app_settings', 'theme'), 
                    s => { if(s.exists()) setConfig(prev => ({...prev, ...s.data()})); }
                );
                return () => { unsubPhotos(); unsubConfig(); };
            }, [user]);

            // L√≥gica de Reacciones Gen√©rica
            const toggleReaction = async (photo, reactionType) => {
                if(!user) return;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'workshop_photos', photo.id);
                const fieldName = reactionType.field;
                const liked = photo[fieldName]?.includes(user.uid);
                
                // Objeto din√°mico para actualizar solo el campo espec√≠fico
                const updateData = {};
                updateData[fieldName] = liked ? arrayRemove(user.uid) : arrayUnion(user.uid);
                
                await updateDoc(ref, updateData);
            };

            const deletePhoto = async (id) => {
                if(confirm("¬øEliminar?")) { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'workshop_photos', id)); setViewerPhotoId(null); addToast("Eliminado", "success"); }
            };

            // L√≥gica de Navegaci√≥n del Visor
            const currentPhotoIndex = photos.findIndex(p => p.id === viewerPhotoId);
            const currentPhoto = photos[currentPhotoIndex];
            
            const handleNextPhoto = () => {
                if (currentPhotoIndex < photos.length - 1) {
                    setViewerPhotoId(photos[currentPhotoIndex + 1].id);
                }
            };
            
            const handlePrevPhoto = () => {
                if (currentPhotoIndex > 0) {
                    setViewerPhotoId(photos[currentPhotoIndex - 1].id);
                }
            };

            // Upload Logic
            const [upFile, setUpFile] = useState(null);
            const [upDesc, setUpDesc] = useState('');
            const [isUp, setIsUp] = useState(false);
            const [upPreview, setUpPreview] = useState(null);

            const handleUploadConfirm = async () => {
                if(!upFile || !user) return;
                setIsUp(true);
                try {
                    const b64 = await compressImage(upFile);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workshop_photos'), {
                        imageUrl: b64, description: upDesc, photographerName: user.displayName, photographerId: user.uid,
                        likes: [], // Mantener likes vac√≠o inicial para compatibilidad
                        createdAt: serverTimestamp()
                    });
                    addToast("Subido", "success"); setShowUpload(false); setUpFile(null); setUpPreview(null); setUpDesc('');
                } catch(e) { console.error(e); addToast("Error al subir", "error"); } finally { setIsUp(false); }
            };

            if (!user) return <div className="h-screen flex items-center justify-center bg-rose-50 text-red-400"><Loader2 className="animate-spin" size={40}/></div>;

            return (
                <div className="min-h-screen relative font-sans" style={{backgroundColor: '#FEF2F2'}}>
                    <div className="fixed inset-0 pointer-events-none transition-all duration-700 z-0"
                         style={{ backgroundImage: config.backgroundUrl ? `url(${config.backgroundUrl})` : 'none', 
                                  backgroundPosition: 'center', backgroundRepeat: 'no-repeat', backgroundSize: '50%', opacity: 0.15 }} />
                    
                    <ToastContainer toasts={toasts} />

                    {!hasEntered ? (
                        <LoginScreen 
                            onLogin={() => setHasEntered(true)} 
                            addToast={addToast} 
                            config={config} 
                            currentUser={user} 
                            onShowRules={() => setShowRules(true)}
                        />
                    ) : (
                        <>
                            {/* Header */}
                            <header className="fixed top-0 inset-x-0 bg-white/80 backdrop-blur-md border-b border-red-50 z-40 p-3 flex justify-between items-center shadow-sm">
                                <div className="flex items-center gap-2 flex-1 min-w-0 mr-2">
                                    <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-red-500 to-rose-700 flex items-center justify-center text-white flex-shrink-0"><Camera size={16}/></div>
                                    <h1 className="font-serif font-bold text-red-950 truncate text-lg">{config.title}</h1>
                                </div>
                                <div className="flex gap-1 flex-shrink-0">
                                    <button onClick={()=>setShowQR(true)} className="p-2 hover:bg-red-50 rounded-full text-red-800" title="Ver QR"><QrCode size={20}/></button>
                                    <button onClick={()=>setShowRules(true)} className="p-2 hover:bg-red-50 rounded-full text-red-800" title="Ver Reglas"><BookOpen size={20}/></button>
                                    <button onClick={()=>setShowConfig(true)} className="p-2 hover:bg-red-50 rounded-full text-red-800"><Settings size={20}/></button>
                                    <button onClick={()=>confirm("¬øSalir?") && window.location.reload()} className="p-2 hover:bg-red-50 rounded-full text-red-800"><LogOut size={20}/></button>
                                </div>
                            </header>

                            {/* Gallery */}
                            <main className="pt-20 pb-24 px-4 max-w-6xl mx-auto">
                                {photos.length === 0 ? (
                                    <div className="text-center py-20 text-red-300">
                                        <ImageIcon size={48} className="mx-auto mb-4"/>
                                        <p>No hay momentos a√∫n.</p>
                                    </div>
                                ) : (
                                    <div className="columns-2 md:columns-3 gap-4 space-y-4">
                                        {photos.map(p => (
                                            <PhotoCard 
                                                key={p.id} 
                                                photo={p} 
                                                user={user} 
                                                onClick={() => setViewerPhotoId(p.id)} 
                                                toggleReaction={toggleReaction} 
                                            />
                                        ))}
                                    </div>
                                )}
                            </main>

                            {/* Cron√≥metro Flotante (Izquierda) */}
                            <Stopwatch />

                            {/* FAB (Derecha) */}
                            <button onClick={()=>setShowUpload(true)} className="fixed bottom-6 right-6 z-40 bg-red-800 text-white p-4 rounded-full shadow-xl flex items-center gap-2 hover:scale-105 transition-transform">
                                <Camera size={24}/> <span className="font-bold text-sm">Capturar</span>
                            </button>

                            {/* Upload Modal */}
                            {showUpload && (
                                <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
                                    <div className="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col overflow-hidden">
                                        <div className="p-4 border-b flex justify-between">
                                            <h3 className="font-bold text-red-900">Nueva Foto</h3>
                                            <button onClick={()=>{setShowUpload(false); setUpFile(null); setUpPreview(null);}}><X/></button>
                                        </div>
                                        <div className="flex-1 p-4 overflow-y-auto space-y-4">
                                            {!upPreview ? (
                                                <label className="h-40 border-2 border-dashed border-red-200 rounded-xl flex items-center justify-center text-red-400 flex-col cursor-pointer">
                                                    <Camera size={32} className="mb-2"/> Toca para elegir
                                                    <input type="file" className="hidden" accept="image/*" onChange={e=>{
                                                        const f = e.target.files[0]; if(f){setUpFile(f); const r=new FileReader();r.onload=()=>setUpPreview(r.result);r.readAsDataURL(f);}
                                                    }}/>
                                                </label>
                                            ) : (
                                                <div className="relative">
                                                    <img src={upPreview} className="rounded-xl w-full"/>
                                                    <button onClick={()=>{setUpPreview(null); setUpFile(null)}} className="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full"><X size={16}/></button>
                                                </div>
                                            )}
                                            <div className="relative">
                                                <textarea value={upDesc} onChange={e=>setUpDesc(e.target.value)} placeholder="¬øQu√© te hizo detenerte a mirar esta foto?" className="w-full p-4 bg-red-50 rounded-xl h-32"/>
                                            </div>
                                        </div>
                                        <div className="p-4 border-t">
                                            <button onClick={handleUploadConfirm} disabled={!upFile || isUp} className="w-full bg-red-800 text-white py-3 rounded-xl font-bold flex justify-center gap-2">
                                                {isUp ? <Loader2 className="animate-spin"/> : <>Compartir <Send size={18}/></>}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Viewer Modal */}
                            {currentPhoto && (
                                <ImageViewerModal 
                                    photo={currentPhoto} 
                                    user={user} 
                                    onClose={() => setViewerPhotoId(null)} 
                                    onDelete={deletePhoto}
                                    onNext={handleNextPhoto}
                                    onPrev={handlePrevPhoto}
                                    hasNext={currentPhotoIndex < photos.length - 1}
                                    hasPrev={currentPhotoIndex > 0}
                                    toggleReaction={toggleReaction}
                                />
                            )}

                            {/* QR Modal (Reutilizando dise√±o) */}
                            {showQR && (
                                <div className="fixed inset-0 z-[100] bg-red-950/60 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in" onClick={() => setShowQR(false)}>
                                    <div className="bg-white p-6 rounded-3xl max-w-sm w-full text-center shadow-2xl" onClick={e => e.stopPropagation()}>
                                        <h3 className="font-serif text-xl mb-4 text-red-900">Escanea para entrar</h3>
                                        <div className="bg-white p-2 border border-red-100 rounded-xl inline-block mb-4 shadow-inner">
                                            <img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(window.location.href)}`} alt="QR" className="w-48 h-48 mix-blend-multiply" />
                                        </div>
                                        <button onClick={() => setShowQR(false)} className="w-full py-3 rounded-xl bg-red-50 hover:bg-red-100 text-red-900 font-bold text-sm flex items-center justify-center gap-2">
                                            Cerrar
                                        </button>
                                    </div>
                                </div>
                            )}

                            <ConfigModal isOpen={showConfig} onClose={()=>setShowConfig(false)} addToast={addToast} currentConfig={config} />
                        </>
                    )}
                    
                    <RulesModal isOpen={showRules} onClose={() => setShowRules(false)} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
